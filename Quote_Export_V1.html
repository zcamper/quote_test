<html>
<head>
    <meta charset="utf-8" />
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect" />
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B600%3B700&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <title>Quote Export</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style type="text/tailwindcss">
        :root {
            --primary: #0b80ee;
            --text-primary: #111518;
            --text-secondary: #60768a;
        }
        body {
            font-family: 'Inter', 'Noto Sans', sans-serif;
        }
    </style>
</head>
<body>
    <div class="relative flex size-full min-h-screen flex-col bg-gray-50 group/design-root overflow-x-hidden">
        <div class="layout-container flex h-full grow flex-col">
            <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200 bg-white px-6 py-3">
                <div class="flex items-center gap-4 text-text-primary">
                    <div class="size-8 text-[var(--primary)]">
                        <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <path clip-rule="evenodd" d="M24 4H42V17.3333V30.6667H24V44H6V30.6667V17.3333H24V4Z" fill="currentColor" fill-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h1 class="text-text-primary text-xl font-semibold leading-tight">Service Quotes</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button class="flex w-full items-center justify-center gap-2 rounded-full border border-gray-300 bg-white px-4 py-3 text-sm font-semibold text-text-primary shadow-sm hover:bg-gray-100" id="back-btn">
                        <span class="material-symbols-outlined">edit</span>
                        Back to Editing
                    </button>
                    <button class="flex w-full items-center justify-center gap-2 rounded-full bg-[var(--primary)] px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-blue-700" id="export-btn">
                        <span class="material-symbols-outlined">download</span>
                        Export Quote
                    </button>
                </div>
            </header>
            <main class="flex-1 px-4 py-8 md:px-6">
                <div class="mx-auto grid max-w-7xl grid-cols-1 gap-8 lg:grid-cols-3">
                    <div class="lg:col-span-2">
                        <div class="mb-6">
                            <div class="flex items-center gap-2 text-sm text-text-secondary">
                                <a class="hover:text-[var(--primary)]" href="#">Quotes</a>
                                <span>/</span>
                                <a class="hover:text-[var(--primary)]" href="#" id="quote-number-link"></a>
                                <span>/</span>
                                <span class="font-medium text-text-primary">Export Preview</span>
                            </div>
                        </div>
                        <div class="mb-8">
                            <h2 class="text-3xl font-bold text-text-primary">Export Preview</h2>
                            <p class="mt-2 text-text-secondary">Customize the display of pricing information before exporting.</p>
                        </div>
                        <div class="rounded-lg border border-gray-200 bg-white shadow-sm" id="quote-preview">
                            <div class="p-6">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-xl font-semibold text-text-primary" id="quote-number-display"></h3>
                                        <p class="mt-1 text-sm text-text-secondary" id="quote-date"></p>
                                    </div>
                                </div>
                                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div id="customer-info">
                                        <h4 class="text-lg font-semibold text-text-primary">Customer Information</h4>
                                        <div class="mt-2 space-y-1 text-sm text-text-secondary"></div>
                                    </div>
                                    <div id="bill-to-info">
                                        <h4 class="text-lg font-semibold text-text-primary">Bill To</h4>
                                        <div class="mt-2 space-y-1 text-sm text-text-secondary"></div>
                                    </div>
                                    <div id="unit-info">
                                        <h4 class="text-lg font-semibold text-text-primary">Unit Information</h4>
                                        <div class="mt-2 space-y-1 text-sm text-text-secondary"></div>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <h4 class="text-lg font-semibold text-text-primary">Description of Work</h4>
                                    <p class="mt-2 text-text-secondary" id="work-description"></p>
                                </div>
                            </div>
                            <div class="border-t border-gray-200">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left" id="quote-table">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-text-secondary">Item</th>
                                                <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-text-secondary">Description</th>
                                                <th class="px-6 py-3 text-right text-xs font-semibold uppercase tracking-wider text-text-secondary">Quantity</th>
                                                <th class="px-6 py-3 text-right text-xs font-semibold uppercase tracking-wider text-text-secondary">Unit Price</th>
                                                <th class="px-6 py-3 text-right text-xs font-semibold uppercase tracking-wider text-text-secondary">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200 bg-white" id="quote-table-body">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="border-t border-gray-200 bg-gray-50 px-6 py-4 flex justify-end">
                                <div class="text-right" id="summary-details"></div>
                            </div>
                        </div>
                    </div>
                    <aside class="space-y-8">
                        <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
                            <h3 class="text-lg font-semibold text-text-primary">Display Options</h3>
                            <div class="mt-4 space-y-4">
                                <label class="flex items-center gap-3 rounded-lg border border-gray-200 p-4 has-[:checked]:border-[var(--primary)] has-[:checked]:bg-blue-50">
                                    <input checked="" class="h-4 w-4 border-gray-300 text-[var(--primary)] focus:ring-[var(--primary)]" name="display_option" type="radio" value="single_total" />
                                    <span class="text-sm font-medium text-text-primary">Show Single Total</span>
                                </label>
                                <label class="flex items-center gap-3 rounded-lg border border-gray-200 p-4 has-[:checked]:border-[var(--primary)] has-[:checked]:bg-blue-50">
                                    <input class="h-4 w-4 border-gray-300 text-[var(--primary)] focus:ring-[var(--primary)]" name="display_option" type="radio" value="category_breakdown" />
                                    <span class="text-sm font-medium text-text-primary">Show Breakdown by Category</span>
                                </label>
                            </div>
                        </div>
                    </aside>
                </div>
            </main>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const quoteDataString = localStorage.getItem('quoteDataForExport');
            if (!quoteDataString) {
                document.body.innerHTML = '<p>No quote data found. Please go back and export a quote first.</p>';
                return;
            }
            const quoteData = JSON.parse(quoteDataString);
            populatePage(quoteData);

            document.querySelectorAll('input[name="display_option"]').forEach(radio => {
                radio.addEventListener('change', () => populatePage(quoteData));
            });
            document.getElementById('back-btn').addEventListener('click', () => window.close());
            document.getElementById('export-btn').addEventListener('click', () => exportToPdf(quoteData));
        });

        function populatePage(data) {
            // --- Populate Header ---
            document.getElementById('quote-number-link').textContent = `Quote #${data.serviceCallId || 'N/A'}`;
            document.getElementById('quote-number-display').textContent = `Quote #${data.serviceCallId || 'N/A'}`;
            document.getElementById('quote-date').textContent = `Date: ${new Date().toLocaleDateString()}`;

            // --- Populate Customer Info ---
            const customerInfoDiv = document.querySelector('#customer-info > div');
            customerInfoDiv.innerHTML = `
                <p><span class="font-medium text-text-primary">Name:</span> ${data.unitLocation.name}</p>
                <p><span class="font-medium text-text-primary">Company:</span> ${data.unitLocation.company}</p>
                <p>${data.unitLocation.address1}</p>
                <p>${data.unitLocation.address2}</p>
                <p>${data.unitLocation.email}</p>
            `;

            // --- Populate Bill To Info ---
            const billToDiv = document.querySelector('#bill-to-info > div');
            billToDiv.innerHTML = `
                <p><span class="font-medium text-text-primary">Name:</span> ${data.billTo.name}</p>
                <p><span class="font-medium text-text-primary">Company:</span> ${data.billTo.company}</p>
                <p>${data.billTo.address1}</p>
                <p>${data.billTo.address2}</p>
                <p>${data.billTo.email}</p>
            `;

            // --- Populate Unit Info ---
            const unitInfoDiv = document.querySelector('#unit-info > div');
            let unitInfoHtml = '';
            for (const [key, value] of Object.entries(data.unitInfo)) {
                unitInfoHtml += `<p><span class="font-medium text-text-primary">${key.replace('.', ' ')}:</span> ${value}</p>`;
            }
            unitInfoDiv.innerHTML = unitInfoHtml;

            // --- Populate Description ---
            document.getElementById('work-description').textContent = data.description;

            // --- Populate Table ---
            const displayOption = document.querySelector('input[name="display_option"]:checked').value;
            if (displayOption === 'single_total') {
                renderSingleTotal(data);
            } else {
                renderCategoryBreakdown(data);
            }

            // --- Populate Summary ---
            const summaryDiv = document.getElementById('summary-details');
            summaryDiv.innerHTML = `
                <p class="text-sm font-medium text-text-secondary">Subtotal: <span class="ml-2 font-semibold text-text-primary">${data.summary.subTotal}</span></p>
                <p class="text-sm font-medium text-text-secondary">Fees: <span class="ml-2 font-semibold text-text-primary">${data.summary.sethFee}</span></p>
                <p class="text-sm font-medium text-text-secondary">Surcharge: <span class="ml-2 font-semibold text-text-primary">${data.summary.surcharge}</span></p>
                <p class="mt-2 text-lg font-bold text-text-primary">Grand Total: <span class="ml-2 text-[var(--primary)]">${data.summary.grandTotal}</span></p>
            `;
        }

        function renderSingleTotal(data) {
            const tableBody = document.getElementById('quote-table-body');
            let tableHtml = '';
            if (data.parts) {
                data.parts.forEach(part => {
                    const total = (parseFloat(part.qty) || 0) * (parseFloat(part.unitCost) || 0);
                    tableHtml += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-text-primary">${part.part}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-text-secondary">${part.desc}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">${part.qty}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">$${parseFloat(part.unitCost || 0).toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">$${total.toFixed(2)}</td>
                        </tr>
                    `;
                });
            }
            tableBody.innerHTML = tableHtml;
        }

        function renderCategoryBreakdown(data) {
            const tableBody = document.getElementById('quote-table-body');
            let tableHtml = '';
            
            const categories = {
                'Parts': data.summary.partsTotal,
                'Labor': data.summary.laborTotal,
                'Subcontractors': data.summary.subTotal
            };

            for (const [category, total] of Object.entries(categories)) {
                if (total && total !== '$0.00') {
                     tableHtml += `
                        <tr>
                            <td class="px-6 py-4 text-sm font-semibold text-text-primary" colspan="4">${category}</td>
                            <td class="px-6 py-4 text-right text-sm font-semibold text-text-primary">${total}</td>
                        </tr>
                    `;
                }
            }
            tableBody.innerHTML = tableHtml;
        }
        
        function exportToPdf(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text(`Quote #${data.serviceCallId || 'N/A'}`, 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 29);

            doc.autoTable({
                html: '#quote-table',
                startY: 40,
                theme: 'grid',
                headStyles: {
                    fillColor: [11, 128, 238]
                },
            });

            doc.save(`quote_${data.serviceCallId || 'export'}.pdf`);
        }
    </script>
</body>
</html>