<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<title>Stitch Design</title>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
      :root {
        --checkbox-tick-svg: url('data:image/svg+xml,%3csvg viewBox=%270 0 16 16%27 fill=%27rgb(255,255,255)%27 xmlns=%27http://www.w3.org/2000/svg%27%3e%3cpath d=%27M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z%27/%3e%3c/svg%3e');
        --primary-color: #3d7fbd;
        --border-color: #e5e7eb;
        --background-color: #f9fafb;
      }
    </style>
</head>
<body class="bg-gray-50" style='font-family: Inter, "Noto Sans", sans-serif;'>
<div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200 px-10 py-4 shadow-sm">
<div class="flex items-center gap-4 text-gray-800">
<div class="size-6 text-[var(--primary-color)]">
<svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path d="M36.7273 44C33.9891 44 31.6043 39.8386 30.3636 33.69C29.123 39.8386 26.7382 44 24 44C21.2618 44 18.877 39.8386 17.6364 33.69C16.3957 39.8386 14.0109 44 11.2727 44C7.25611 44 4 35.0457 4 24C4 12.9543 7.25611 4 11.2727 4C14.0109 4 16.3957 8.16144 17.6364 14.31C18.877 8.16144 21.2618 4 24 4C26.7382 4 29.123 8.16144 30.3636 14.31C31.6043 8.16144 33.9891 4 36.7273 4C40.7439 4 44 12.9543 44 24C44 35.0457 40.7439 44 36.7273 44Z" fill="currentColor"></path>
</svg>
</div>
<h2 class="text-gray-900 text-xl font-bold leading-tight tracking-[-0.015em]">QuoteCraft</h2>
</div>
<nav class="flex flex-1 justify-center gap-2">
<a class="text-gray-600 hover:text-gray-900 text-sm font-medium leading-normal px-4 py-2 rounded-full transition-colors" href="#">Dashboard</a>
<a class="text-gray-600 hover:text-gray-900 text-sm font-medium leading-normal px-4 py-2 rounded-full transition-colors" href="#">Quotes</a>
<a class="text-gray-600 hover:text-gray-900 text-sm font-medium leading-normal px-4 py-2 rounded-full transition-colors" href="#">Customers</a>
<a class="text-gray-600 hover:text-gray-900 text-sm font-medium leading-normal px-4 py-2 rounded-full transition-colors" href="#">Parts &amp; Services</a>
<a class="bg-gray-100 text-gray-900 text-sm font-semibold leading-normal px-4 py-2 rounded-full" href="#">Inspection Checklist</a>
</nav>
<div class="flex items-center gap-4">
<button class="relative">
<span class="material-icons text-gray-600 hover:text-gray-900">notifications</span>
<span class="absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full"></span>
</button>
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAKyCLZ6hRJVmJ_4CEfuN_PKIsHDyIul8s9U3WteLAl-IyyZDbdh_GyQORb81Z6jsI5WtiHRHMfLCauJJ1cbH3GeAPeiS2ri6Bwm5zUV3JVYHpjkKGjExJIS3JUE_eAVf-Km-P4GRNYMdfbKgPyPfnYkS5KtZva-0KPUOJ8DZgbYUA9BtRP3xFZhn3olNOO_iCzY5y46jQhUkBB1SVAxD9Sk1cZeCTiP9OOaIGWbYWx8YTMxQ6J1uLevehUE-rgzOyCcLBpgV06mbA");'></div>
</div>
</header>
<main class="flex-1 bg-[var(--background-color)]">
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">
<div class="flex flex-col gap-8">
    <!-- Checklist Selection Header -->
    <header class="flex flex-wrap items-center justify-between gap-y-4 gap-x-8 bg-white p-6 rounded-2xl shadow-sm border border-[var(--border-color)]">
        <div class="flex flex-col gap-1 flex-grow min-w-[200px]">
            <h1 class="text-gray-900 text-3xl font-bold leading-tight tracking-tight" id="main-title">Inspection Checklists</h1>
            <p class="text-gray-500 text-base font-normal leading-normal" id="main-description">Select a checklist to view or edit its items.</p>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
            <select id="checklist-select" class="h-11 rounded-full border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                <option value="">-- Select a Checklist --</option>
            </select>
            <button id="new-checklist-btn" class="flex items-center justify-center size-11 rounded-full bg-white border border-gray-300 text-gray-600 hover:bg-gray-50 transition-colors" title="New Checklist">
                <span class="material-icons">add</span>
            </button>
            <button id="rename-checklist-btn" class="flex items-center justify-center size-11 rounded-full bg-white border border-gray-300 text-gray-600 hover:bg-gray-50 transition-colors" title="Rename Selected Checklist" disabled>
                <span class="material-icons">drive_file_rename_outline</span>
            </button>
            <button id="delete-checklist-btn" class="flex items-center justify-center size-11 rounded-full bg-white border border-gray-300 text-red-500 hover:bg-red-50 transition-colors" title="Delete Selected Checklist" disabled>
                <span class="material-icons">delete_outline</span>
            </button>
        </div>
    </header>

    <!-- Checklist Items Section -->
    <div id="items-container" class="hidden">
        <div class="flex justify-end mb-4">
             <button id="add-item-btn" class="flex items-center gap-2 min-w-[84px] max-w-[480px] cursor-pointer justify-center overflow-hidden rounded-full h-11 px-5 bg-[var(--primary-color)] text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-blue-700 transition-colors">
                <span class="material-icons text-lg">add</span>
                <span class="truncate">Add New Item</span>
            </button>
        </div>
        <div class="overflow-x-auto bg-white rounded-2xl shadow-sm border border-[var(--border-color)]">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th class="px-6 py-4 font-semibold" scope="col">Item Text</th>
                        <th class="px-6 py-4 font-semibold" scope="col">Category</th>
                        <th class="px-6 py-4 font-semibold text-center" scope="col">Required</th>
                        <th class="px-6 py-4 font-semibold text-right" scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="checklist-tbody">
                    <!-- Rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>
</main>
</div>
</div>

<!-- Modal for Add/Edit Item -->
<div id="item-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Add New Checklist Item</h3>
            <div class="mt-2 px-7 py-3">
                <form id="item-form">
                    <input type="hidden" id="item-id">
                    <div class="mb-4 text-left">
                        <label for="item-text" class="block text-sm font-medium text-gray-700">Item Text</label>
                        <input type="text" id="item-text" name="item-text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                    </div>
                    <div class="mb-4 text-left">
                        <label for="item-category" class="block text-sm font-medium text-gray-700">Category</label>
                        <input type="text" id="item-category" name="item-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <div class="mb-4 text-left">
                        <label class="flex items-center">
                            <input type="checkbox" id="item-required" name="item-required" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-offset-0 focus:ring-indigo-200 focus:ring-opacity-50" checked>
                            <span class="ml-2 text-sm text-gray-600">Required</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="items-center px-4 py-3">
                <button id="save-item-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    Save
                </button>
                <button id="cancel-btn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_BASE_URL = 'http://localhost:3000/api';
    
    // State
    let checklistsCache = [];
    let itemsCache = [];
    let currentChecklistId = null;

    // Checklist UI Elements
    const checklistSelect = document.getElementById('checklist-select');
    const newChecklistBtn = document.getElementById('new-checklist-btn');
    const renameChecklistBtn = document.getElementById('rename-checklist-btn');
    const deleteChecklistBtn = document.getElementById('delete-checklist-btn');
    const mainTitle = document.getElementById('main-title');
    const mainDescription = document.getElementById('main-description');

    // Items UI Elements
    const itemsContainer = document.getElementById('items-container');
    const tbody = document.getElementById('checklist-tbody');
    const addItemBtn = document.getElementById('add-item-btn');
    
    // Modal UI Elements
    const modal = document.getElementById('item-modal');
    const modalTitle = document.getElementById('modal-title');
    const cancelBtn = document.getElementById('cancel-btn');
    const saveBtn = document.getElementById('save-item-btn');
    const form = document.getElementById('item-form');
    const itemIdInput = document.getElementById('item-id');
    const itemTextInput = document.getElementById('item-text');
    const itemCategoryInput = document.getElementById('item-category');
    const itemRequiredInput = document.getElementById('item-required');

    // --- API Functions ---
    const api = {
        getChecklists: () => fetch(`${API_BASE_URL}/checklists`).then(res => res.json()),
        createChecklist: (name) => fetch(`${API_BASE_URL}/checklists`, {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name })
        }).then(res => res.json()),
        renameChecklist: (id, name) => fetch(`${API_BASE_URL}/checklists/${id}`, {
            method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name })
        }),
        deleteChecklist: (id) => fetch(`${API_BASE_URL}/checklists/${id}`, { method: 'DELETE' }),
        
        getItems: (checklistId) => fetch(`${API_BASE_URL}/checklists/${checklistId}/items`).then(res => res.json()),
        createItem: (checklistId, data) => fetch(`${API_BASE_URL}/checklists/${checklistId}/items`, {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        }),
        updateItem: (itemId, data) => fetch(`${API_BASE_URL}/checklist-items/${itemId}`, {
            method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        }),
        deleteItem: (itemId) => fetch(`${API_BASE_URL}/checklist-items/${itemId}`, { method: 'DELETE' })
    };

    // --- UI Update Functions ---
    const updateChecklistDropdown = () => {
        checklistSelect.innerHTML = '<option value="">-- Select a Checklist --</option>';
        checklistsCache.forEach(c => {
            const option = new Option(c.name, c.id);
            checklistSelect.add(option);
        });
        checklistSelect.value = currentChecklistId;
    };

    const updateUIForSelection = () => {
        const isChecklistSelected = !!currentChecklistId;
        renameChecklistBtn.disabled = !isChecklistSelected;
        deleteChecklistBtn.disabled = !isChecklistSelected;
        itemsContainer.classList.toggle('hidden', !isChecklistSelected);

        if (isChecklistSelected) {
            const selected = checklistsCache.find(c => c.id == currentChecklistId);
            mainTitle.textContent = selected.name;
            mainDescription.textContent = `Manage the items for the "${selected.name}" checklist.`;
        } else {
            mainTitle.textContent = 'Inspection Checklists';
            mainDescription.textContent = 'Select a checklist to view or edit its items, or create a new one.';
        }
    };

    const renderItemsTable = () => {
        tbody.innerHTML = '';
        if (itemsCache.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">No items in this checklist. Click "Add New Item" to get started.</td></tr>`;
            return;
        }
        itemsCache.forEach((item) => {
            const tr = document.createElement('tr');
            tr.className = 'bg-white border-b hover:bg-gray-50';
            tr.dataset.id = item.id;
            tr.innerHTML = `
                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${item.item_text}</td>
                <td class="px-6 py-4"><span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${item.category || 'N/A'}</span></td>
                <td class="px-6 py-4 text-center">
                    <input type="checkbox" class="h-5 w-5 rounded border-gray-300" ${item.is_required ? 'checked' : ''} disabled>
                </td>
                <td class="px-6 py-4 text-right flex items-center justify-end gap-2">
                    <button class="p-2 rounded-full hover:bg-gray-200 transition-colors edit-btn" data-id="${item.id}"><span class="material-icons text-gray-600 pointer-events-none">edit</span></button>
                    <button class="p-2 rounded-full hover:bg-red-100 transition-colors delete-btn" data-id="${item.id}"><span class="material-icons text-red-500 pointer-events-none">delete</span></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    };

    // --- Main Logic Functions ---
    const loadChecklists = async () => {
        try {
            checklistsCache = await api.getChecklists();
            updateChecklistDropdown();
            // If there was a selection, try to maintain it. Otherwise, select nothing.
            const selectedExists = checklistsCache.some(c => c.id == currentChecklistId);
            if (!selectedExists) {
                currentChecklistId = null;
            }
            updateUIForSelection();
        } catch (error) {
            console.error('Failed to load checklists:', error);
            alert('Could not load checklists. Is the API server running?');
        }
    };

    const handleChecklistSelection = async (id) => {
        currentChecklistId = id ? parseInt(id, 10) : null;
        updateUIForSelection();
        if (currentChecklistId) {
            try {
                itemsCache = await api.getItems(currentChecklistId);
                renderItemsTable();
            } catch (error) {
                console.error(`Failed to load items for checklist ${currentChecklistId}:`, error);
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Error loading items.</td></tr>`;
            }
        } else {
            itemsCache = [];
            renderItemsTable();
        }
    };

    // --- Event Handlers ---
    checklistSelect.addEventListener('change', () => handleChecklistSelection(checklistSelect.value));

    newChecklistBtn.addEventListener('click', async () => {
        const name = prompt('Enter the name for the new checklist:');
        if (name) {
            try {
                const newChecklist = await api.createChecklist(name);
                if (newChecklist.id) {
                    currentChecklistId = newChecklist.id;
                    await loadChecklists();
                    handleChecklistSelection(currentChecklistId);
                } else {
                    alert(`Error: ${newChecklist.error || 'Could not create checklist.'}`);
                }
            } catch (error) {
                console.error('Error creating checklist:', error);
                alert('Failed to create checklist.');
            }
        }
    });

    renameChecklistBtn.addEventListener('click', async () => {
        if (!currentChecklistId) return;
        const selected = checklistsCache.find(c => c.id == currentChecklistId);
        const newName = prompt('Enter the new name for the checklist:', selected.name);
        if (newName && newName !== selected.name) {
            try {
                await api.renameChecklist(currentChecklistId, newName);
                await loadChecklists();
            } catch (error) {
                console.error('Error renaming checklist:', error);
                alert('Failed to rename checklist.');
            }
        }
    });

    deleteChecklistBtn.addEventListener('click', async () => {
        if (!currentChecklistId) return;
        const selected = checklistsCache.find(c => c.id == currentChecklistId);
        if (confirm(`Are you sure you want to delete the "${selected.name}" checklist and all its items? This cannot be undone.`)) {
            try {
                await api.deleteChecklist(currentChecklistId);
                currentChecklistId = null;
                await loadChecklists();
                handleChecklistSelection(null);
            } catch (error) {
                console.error('Error deleting checklist:', error);
                alert('Failed to delete checklist.');
            }
        }
    });

    // --- Item Modal Logic ---
    const openModal = (item = null) => {
        form.reset();
        if (item) {
            modalTitle.textContent = 'Edit Checklist Item';
            itemIdInput.value = item.id;
            itemTextInput.value = item.item_text;
            itemCategoryInput.value = item.category;
            itemRequiredInput.checked = item.is_required;
        } else {
            modalTitle.textContent = 'Add New Checklist Item';
            itemIdInput.value = '';
        }
        modal.classList.remove('hidden');
    };

    const closeModal = () => modal.classList.add('hidden');

    const handleItemFormSubmit = async () => {
        if (!currentChecklistId) return;
        const id = itemIdInput.value ? parseInt(itemIdInput.value, 10) : null;
        const itemData = {
            item_text: itemTextInput.value,
            category: itemCategoryInput.value,
            is_required: itemRequiredInput.checked,
            display_order: id ? itemsCache.find(i => i.id == id).display_order : itemsCache.length + 1
        };

        try {
            const promise = id ? api.updateItem(id, itemData) : api.createItem(currentChecklistId, itemData);
            const response = await promise;
            if (!response.ok) throw new Error(await response.text());
            closeModal();
            handleChecklistSelection(currentChecklistId); // Refresh table
        } catch (error) {
            console.error('Error saving item:', error);
            alert('Could not save the item.');
        }
    };

    const handleItemDelete = async (id) => {
        if (!confirm('Are you sure you want to delete this item?')) return;
        try {
            await api.deleteItem(id);
            handleChecklistSelection(currentChecklistId); // Refresh table
        } catch (error) {
            console.error('Error deleting item:', error);
            alert('Could not delete the item.');
        }
    };

    addItemBtn.addEventListener('click', () => openModal());
    cancelBtn.addEventListener('click', closeModal);
    saveBtn.addEventListener('click', handleItemFormSubmit);
    tbody.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-btn');
        const deleteBtn = e.target.closest('.delete-btn');
        if (editBtn) {
            const id = editBtn.dataset.id;
            const item = itemsCache.find(i => i.id == id);
            openModal(item);
        } else if (deleteBtn) {
            const id = deleteBtn.dataset.id;
            handleItemDelete(id);
        }
    });

    // Initial Load
    loadChecklists();
});
</script>
</body>
</html>
