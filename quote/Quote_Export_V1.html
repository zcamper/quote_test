<!DOCTYPE html>
<html><head>
<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com;">
<meta charset="utf-8"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B600%3B700&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<title>Stitch Design</title>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<style type="text/tailwindcss">
      :root {
        --primary: #0b80ee;
        --secondary: #f0f2f5;
        --text-primary: #111518;
        --text-secondary: #60768a;
      }
      body {
        font-family: 'Inter', 'Noto Sans', sans-serif;
      }
    </style>
</head>
<body>
<div class="relative flex size-full min-h-screen flex-col bg-gray-50 group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200 px-10 py-4 shadow-sm">
<div class="flex items-center gap-4 text-gray-800">
<div class="size-6 text-[var(--primary-color)]">
<svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path d="M36.7273 44C33.9891 44 31.6043 39.8386 30.3636 33.69C29.123 39.8386 26.7382 44 24 44C21.2618 44 18.877 39.8386 17.6364 33.69C16.3957 39.8386 14.0109 44 11.2727 44C7.25611 44 4 35.0457 4 24C4 12.9543 7.25611 4 11.2727 4C14.0109 4 16.3957 8.16144 17.6364 14.31C18.877 8.16144 21.2618 4 24 4C26.7382 4 29.123 8.16144 30.3636 14.31C31.6043 8.16144 33.9891 4 36.7273 4C40.7439 4 44 12.9543 44 24C44 35.0457 40.7439 44 36.7273 44Z" fill="currentColor"></path>
</svg>
</div>
<h2 class="text-gray-900 text-xl font-bold leading-tight tracking-[-0.015em]">QuoteCraft</h2>
</div>
<nav class="flex flex-1 justify-center gap-2">
<a class="text-gray-600 hover:text-gray-900 text-sm font-medium leading-normal px-4 py-2 rounded-full transition-colors" href="/dashboard/dashboard.html">Dashboard</a>
<a class="text-gray-600 hover:text-gray-900 text-sm font-medium leading-normal px-4 py-2 rounded-full transition-colors" href="/quote/quote_mgnt.html">Quotes</a>
<a class="text-gray-600 hover:text-gray-900 text-sm font-medium leading-normal px-4 py-2 rounded-full transition-colors" href="/settings/user-mngmt.html">Customers</a>
<a class="text-gray-600 hover:text-gray-900 text-sm font-medium leading-normal px-4 py-2 rounded-full transition-colors" href="#">Parts &amp; Services</a>
<a class="text-gray-600 hover:text-gray-900 text-sm font-medium leading-normal px-4 py-2 rounded-full transition-colors" href="/checklist/inspection_mgmnt.html">Inspection Checklist</a>
</nav>
<div class="flex items-center gap-4">
<button class="relative">
<span class="material-icons text-gray-600 hover:text-gray-900">notifications</span>
<span class="absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full"></span>
</button>
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 user-avatar-mgmnt"></div>
</div>
</header>
<main class="flex-1 px-4 py-8 md:px-6">
<div class="mx-auto grid max-w-7xl grid-cols-1 gap-8 lg:grid-cols-3">
<div class="lg:col-span-2">
<div class="mb-6">
<div class="flex items-center gap-2 text-sm text-text-secondary">
<a class="hover:text-[var(--primary)]" href="#">Quotes</a>
<span>/</span>
<a class="hover:text-[var(--primary)]" href="#" id="quote-number-link">Quote #</a>
<span>/</span>
<span class="font-medium text-text-primary">Export Preview</span>
</div>
</div>
<div class="mb-8">
<h2 class="text-3xl font-bold text-text-primary">Export Preview</h2>
<p class="mt-2 text-text-secondary">Customize the display of pricing information before exporting.</p>
</div>
<div class="rounded-lg border border-gray-200 bg-white shadow-sm" id="quote-preview">
<div class="p-6">
<div class="flex justify-between items-start">
<div>
<h3 class="text-xl font-semibold text-text-primary" id="quote-number-display">Quote #12345</h3>
<p class="mt-1 text-sm text-text-secondary">Date: 2024-01-15</p>
</div>
<div class="text-right">
<p class="font-semibold text-text-primary">Main Branch</p>
<p class="text-sm text-text-secondary">123 Industrial Way, Anytown, USA</p>
</div>
</div>
<div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
<div>
<h4 class="text-lg font-semibold text-text-primary">Customer Information</h4>
<div class="mt-2 space-y-1 text-sm text-text-secondary">
<p><span class="font-medium text-text-primary">Name:</span></p>
<p><span class="font-medium text-text-primary">Company:</span></p>
</div>
</div>
<div>
<h4 class="text-lg font-semibold text-text-primary">Bill To</h4>
<div class="mt-2 space-y-1 text-sm text-text-secondary">
<p><span class="font-medium text-text-primary">Name:</span></p>
<p><span class="font-medium text-text-primary">Company:</span></p>
</div>
</div>
<div>
<h4 class="text-lg font-semibold text-text-primary">Unit Information</h4>
<div class="mt-2 space-y-1 text-sm text-text-secondary">
<p><span class="font-medium text-text-primary">Unit:</span> Excavator</p>
<p><span class="font-medium text-text-primary">Model:</span> CAT 336</p>
<p><span class="font-medium text-text-primary">Serial #:</span> XYZ123456</p>
<p><span class="font-medium text-text-primary">Hours:</span> 4,500</p>
</div>
</div>
</div>
<div class="mt-6">
<h4 class="text-lg font-semibold text-text-primary">Description of Work</h4>
<p class="mt-2 text-text-secondary">
                      Comprehensive maintenance and repair services for the excavator, including engine overhaul, hydraulic system repairs, and replacement of worn-out parts. The work
                      ensures optimal performance and extends the lifespan of the equipment.
                    </p>
</div>
</div>
<div class="border-t border-gray-200">
<div class="overflow-x-auto">
<table class="w-full text-left" id="quote-table">
<thead class="bg-gray-50">
<tr>
<th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-text-secondary">Item</th>
<th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-text-secondary">Description</th>
<th class="px-6 py-3 text-right text-xs font-semibold uppercase tracking-wider text-text-secondary">Quantity</th>
<th class="px-6 py-3 text-right text-xs font-semibold uppercase tracking-wider text-text-secondary">Unit Price</th>
<th class="px-6 py-3 text-right text-xs font-semibold uppercase tracking-wider text-text-secondary">Total</th>
</tr>
</thead>
<tbody class="divide-y divide-gray-200 bg-white">
<tr>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-text-primary">Engine Overhaul</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-text-secondary">Complete engine overhaul with new pistons, rings, and bearings.</td>
<td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">1</td>
<td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">$5,000.00</td>
<td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">$5,000.00</td>
</tr>
<tr>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-text-primary">Hydraulic System Repair</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-text-secondary">Repair and replacement of hydraulic hoses and seals.</td>
<td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">1</td>
<td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">$2,500.00</td>
<td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">$2,500.00</td>
</tr>
<tr>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-text-primary">Parts Replacement</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-text-secondary">Replacement of worn-out parts including filters and belts.</td>
<td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">1</td>
<td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">$1,500.00</td>
<td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">$1,500.00</td>
</tr>
<tr>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-text-primary">Labor</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-text-secondary">Skilled technician labor for all repair and maintenance tasks.</td>
<td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">40 hours</td>
<td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">$100.00/hour</td>
<td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">$4,000.00</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="border-t border-gray-200 bg-gray-50 px-6 py-4 flex justify-between items-end">
<div class="flex items-center gap-4">
<img alt="QR Code for Quote Approval" class="w-32 h-32" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCE-4At60OdXh3jWLXFyyITk45e36haD8-rCqwzWTGYlVakpbPp8kJLyEPrWflGWMwCCy0ltxXAZMe4-Q-s6BYFXKDLJIpPeuDyLU_xM3ir6Os_QzsQ82RdGskkpYFOm8xHcdRKqw1yO-9YPD96I7b1swDpu4g4bZs_FDY5UnvOPhl3zsNISIhu4MA-gmvajC7FyGvXLY34TWc0xnRb7W3NyoyTvofm91ZljYINyTTvIXf-6uyPxkezlGWQNGzFCq9ZmwAMld9apq0"/>
<div class="text-sm text-text-secondary">
<p class="font-semibold text-text-primary">Scan to Approve</p>
<p>Initiates an email to:</p>
<p class="font-medium text-text-primary">mainbranch.approvals@example.com</p>
</div>
<div class="space-y-3">
    <div class="flex justify-between items-center">
      <p class="text-sm text-text-secondary">Parts Total</p>
      <p class="summary-value text-sm font-medium text-text-primary" data-summary="parts-total"></p>
    </div>
    <div class="flex justify-between items-center">
      <p class="text-sm text-text-secondary">Technician Labor</p>
      <p class="summary-value text-sm font-medium text-text-primary" data-summary="tech-labor"></p>
    </div>
    <div class="flex justify-between items-center">
      <p class="text-sm text-text-secondary">Travel Labor</p>
      <p class="summary-value text-sm font-medium text-text-primary" data-summary="travel-labor"></p>
    </div>
    <div class="flex justify-between items-center">
      <p class="text-sm text-text-secondary">Subcontractor Total</p>
      <p class="summary-value text-sm font-medium text-text-primary" data-summary="sub-total"></p>
    </div>
    <div class="flex justify-between items-center">
      <p class="text-sm text-text-secondary">S.E.TH Fee (1.5%)</p>
      <p class="summary-value text-sm font-medium text-text-primary" data-summary="seth-fee"></p>
    </div>
    <div class="flex justify-between items-center">
      <p class="text-sm text-text-secondary">Fuel & Material Surcharge</p>
      <p class="summary-value text-sm font-medium text-text-primary" data-summary="surcharge"></p>
    </div>
    <div class="flex justify-between items-center pt-4 border-t border-dashed border-gray-300">
      <p class="text-base font-semibold text-text-primary">Grand Total</p>
      <p class="summary-value text-2xl font-bold text-[var(--primary)]" data-summary="grand-total"></p>
    </div>
  </div>
</div>
</div>

</div>


</aside>
</div>
<!-- Replace old totals section with new options -->
<div id="options" class="border-t border-gray-200 bg-gray-50 px-6 py-4">
  <h3 class="text-lg font-semibold text-text-primary mb-4">Options</h3>
  <div class="space-y-3">
    <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
<h3 class="text-lg font-semibold text-text-primary">Display Options</h3>
<div class="mt-4 space-y-4">
<label class="flex items-center gap-3 rounded-lg border border-gray-200 p-4 has-[:checked]:border-[var(--primary)] has-[:checked]:bg-blue-50">
<input checked="" class="h-4 w-4 border-gray-300 text-[var(--primary)] focus:ring-[var(--primary)]" name="display_option" type="radio" value="single">
<span class="text-sm font-medium text-text-primary">Show Single Total</span>
</label>
<label class="flex items-center gap-3 rounded-lg border border-gray-200 p-4 has-[:checked]:border-[var(--primary)] has-[:checked]:bg-blue-50">
<input class="h-4 w-4 border-gray-300 text-[var(--primary)] focus:ring-[var(--primary)]" name="display_option" type="radio" value="category">
<span class="text-sm font-medium text-text-primary">Show Breakdown by Category</span>
</label>
<div class="border-t border-gray-200 pt-4">
<h4 class="text-base font-semibold text-text-primary">Included Items</h4>
<div class="mt-3 space-y-3">
<label class="flex items-center gap-3">
<input checked="" class="h-4 w-4 rounded border-gray-300 text-[var(--primary)] focus:ring-[var(--primary)]" type="checkbox" id="show-parts">
<span class="text-sm text-text-primary">Show Parts</span>
</label>
<label class="flex items-center gap-3">
<input checked="" class="h-4 w-4 rounded border-gray-300 text-[var(--primary)] focus:ring-[var(--primary)]" type="checkbox" id="show-subcontractors">
<span class="text-sm text-text-primary">Show Subcontractors</span>
</label>
<label class="flex items-center gap-3">
<input checked="" class="h-4 w-4 rounded border-gray-300 text-[var(--primary)] focus:ring-[var(--primary)]" type="checkbox" id="show-labor-hours">
<span class="text-sm text-text-primary">Show Labor Hours</span>
</label>
<label class="flex items-center gap-3">
<input checked="" class="h-4 w-4 rounded border-gray-300 text-[var(--primary)] focus:ring-[var(--primary)]" type="checkbox" id="show-num-techs">
<span class="text-sm text-text-primary">Show Number of Techs</span>
</label>
<label class="flex items-center gap-3">
<input class="h-4 w-4 rounded border-gray-300 text-[var(--primary)] focus:ring-[var(--primary)]" type="checkbox" id="exclude-surcharge">
<span class="text-sm text-text-primary">Exclude Fuel & Material Surcharge</span>
</label>
</div>
<aside class="space-y-8">

<div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
<h3 class="text-lg font-semibold text-text-primary">Export Formats</h3>
<div class="mt-4 space-y-3">
<label class="flex items-center gap-3">
<input checked="" class="h-4 w-4 rounded border-gray-300 text-[var(--primary)] focus:ring-[var(--primary)]" id="check-pdf" type="checkbox">
<span class="text-sm text-text-primary">PDF</span>
</label>
<label class="flex items-center gap-3">
<input class="h-4 w-4 rounded border-gray-300 text-[var(--primary)] focus:ring-[var(--primary)]" id="check-csv" type="checkbox">
<span class="text-sm text-text-primary">CSV</span>
</label>
<label class="flex items-center gap-3">
<input class="h-4 w-4 rounded border-gray-300 text-[var(--primary)] focus:ring-[var(--primary)]" id="check-excel" type="checkbox">
<span class="text-sm text-text-primary">Excel</span>
</label>
</div>
</div>
<div class="flex flex-col gap-4">
<button class="flex w-full items-center justify-center gap-2 rounded-full bg-[var(--primary)] px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-blue-700" id="export-btn">
<span class="material-symbols-outlined"> download </span>
                  Export Quote
                </button>
<button class="flex w-full items-center justify-center gap-2 rounded-full border border-gray-300 bg-white px-4 py-3 text-sm font-semibold text-text-primary shadow-sm hover:bg-gray-100" id="back-btn">
<span class="material-symbols-outlined"> edit </span>
                  Back to Editing
                </button>
</div>
</aside>
</div>
</div>
</div>
</div>
  </div>
</div>
</main>
</div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const quoteDataString = localStorage.getItem('quoteDataForExport');
        let quoteData;

        if (quoteDataString) {
            quoteData = JSON.parse(quoteDataString);
            populateStaticData(quoteData);
            setupEventListeners();
            updateDisplay(); // Initial render
        } else {
            console.error('Quote data not found in localStorage.');
            // Optionally, display a message to the user
        }

        function populateStaticData(data) {
            // Update Quote Number
            const quoteNumber = data.quoteNumber || 'N/A';
            document.getElementById('quote-number-link').textContent = `Quote #${quoteNumber}`;
            document.getElementById('quote-number-display').textContent = `Quote #${quoteNumber}`;

            // Populate Customer Information
            const customerInfoTitle = Array.from(document.querySelectorAll('h4')).find(h4 => h4.textContent === 'Customer Information');
            if(customerInfoTitle && data.customer){
                const customerInfoDiv = customerInfoTitle.nextElementSibling;
                customerInfoDiv.innerHTML = `
                    <p><span class="font-medium text-text-primary">Name:</span> ${data.customer.name || 'N/A'}</p>
                    <p><span class="font-medium text-text-primary">Company:</span> ${data.customer.company || 'N/A'}</p>
                `;
            }

            // Populate Bill To Information
            const billToTitle = Array.from(document.querySelectorAll('h4')).find(h4 => h4.textContent === 'Bill To');
            if(billToTitle && data.billTo){
                const billToDiv = billToTitle.nextElementSibling;
                billToDiv.innerHTML = `
                    <p><span class="font-medium text-text-primary">Name:</span> ${data.billTo.name || 'N/A'}</p>
                    <p><span class="font-medium text-text-primary">Company:</span> ${data.billTo.company || 'N/A'}</p>
                `;
            }

            // Populate Unit Information
            const unitInfoTitle = Array.from(document.querySelectorAll('h4')).find(h4 => h4.textContent === 'Unit Information');
            if(unitInfoTitle && data.unitInfo){
                const unitInfoDiv = unitInfoTitle.nextElementSibling;
                unitInfoDiv.innerHTML = `
                    <p><span class="font-medium text-text-primary">Generator Model:</span> ${data.unitInfo['generator.model'] || 'N/A'}</p>
                    <p><span class="font-medium text-text-primary">Generator Serial:</span> ${data.unitInfo['generator.serial'] || 'N/A'}</p>
                    <p><span class="font-medium text-text-primary">ATS Model:</span> ${data.unitInfo['ats.model'] || 'N/A'}</p>
                    <p><span class="font-medium text-text-primary">ATS Serial:</span> ${data.unitInfo['ats.serial'] || 'N/A'}</p>
                    <p><span class="font-medium text-text-primary">Engine Model:</span> ${data.unitInfo['engine.model'] || 'N/A'}</p>
                    <p><span class="font-medium text-text-primary">Engine Serial:</span> ${data.unitInfo['engine.serial'] || 'N/A'}</p>
                `;
            }

            // Populate Description of Work
            const descTitle = Array.from(document.querySelectorAll('h4')).find(h4 => h4.textContent === 'Description of Work');
            if(descTitle && data.description){
                descTitle.nextElementSibling.textContent = data.description;
            }
        }

        function setupEventListeners() {
            // Attach event listeners to all display option checkboxes and radios
            document.querySelectorAll('#show-parts, #show-subcontractors, #show-labor-hours, #show-num-techs, #exclude-surcharge').forEach(checkbox => {
                checkbox.addEventListener('change', updateDisplay);
            });
            document.querySelectorAll('input[name="display_option"]').forEach(radio => {
                radio.addEventListener('change', updateDisplay);
            });

            // Export and Back buttons
            document.getElementById('export-btn').addEventListener('click', handleExport);
            document.getElementById('back-btn').addEventListener('click', () => window.history.back());
        }

        function formatCurrency(value) {
            const number = Number(value);
            return isNaN(number) ? '$0.00' : number.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }

        function parseCurrency(value) {
            if (typeof value === 'number') return value;
            if (typeof value !== 'string') return 0;
            return parseFloat(value.replace(/[^0-9.-]+/g, '')) || 0;
        }

        function renderSingleTotal() {
            const tableBody = document.querySelector('#quote-table tbody');
            tableBody.innerHTML = '';
            if (quoteData.parts) {
                quoteData.parts.forEach(part => {
                    const row = tableBody.insertRow();
                    const total = (part.qty || 0) * (part.unitCost || 0);
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-text-primary">${part.part || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-text-secondary">${part.desc || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">${part.qty || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">${formatCurrency(part.unitCost)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-secondary">${formatCurrency(total)}</td>
                    `;
                });
            }
        }

        function renderCategoryBreakdown() {
            const tableBody = document.querySelector('#quote-table tbody');
            tableBody.innerHTML = ''; // Clear existing rows
            const categories = {
                'Parts': [],
                'Labor': [],
                'Subcontractor': [],
                'Fees & Surcharges': []
            };

            // Categorize Parts
            if (quoteData.parts) {
                quoteData.parts.forEach(part => {
                    categories['Parts'].push({
                        description: `${part.part} - ${part.desc}`,
                        amount: (parseFloat(part.qty) || 0) * (parseFloat(part.unitCost) || 0)
                    });
                });
            }

            // Categorize Labor
            if (quoteData.labor) {
                const techLaborTotal = (parseFloat(quoteData.labor.techCount) || 0) * (parseFloat(quoteData.labor.techHours) || 0) * (parseFloat(quoteData.labor.techRate) || 0);
                if (techLaborTotal > 0) {
                    categories['Labor'].push({
                        description: `Technician Labor (${quoteData.labor.techCount} tech(s) @ ${quoteData.labor.techHours} hrs)`,
                        amount: techLaborTotal
                    });
                }
                const travelLaborTotal = (parseFloat(quoteData.labor.travelHours) || 0) * (parseFloat(quoteData.labor.travelRate) || 0);
                if (travelLaborTotal > 0) {
                    categories['Labor'].push({
                        description: `Travel Labor (${quoteData.labor.travelHours} hrs)`,
                        amount: travelLaborTotal
                    });
                }
            }

            // Categorize Subcontractors
            if (quoteData.subcontractors) {
                quoteData.subcontractors.forEach(sub => {
                    categories['Subcontractor'].push({
                        description: sub.contact_name,
                        amount: parseFloat(sub.cost) || 0
                    });
                });
            }

            // Categorize Fees
            if (quoteData.summary) {
                const sethFee = parseCurrency(quoteData.summary.sethFee);
                const surcharge = parseCurrency(quoteData.summary.surcharge);
                if (sethFee > 0) categories['Fees & Surcharges'].push({ description: 'S.E.TH Fee (1.5%)', amount: sethFee });
                if (surcharge > 0 && !document.getElementById('exclude-surcharge').checked) {
                     categories['Fees & Surcharges'].push({ description: 'Fuel & Material Surcharge', amount: surcharge });
                }
            }

            let html = '';
            for (const category in categories) {
                if (categories[category].length > 0) {
                    let categoryTotal = 0;
                    html += `<tr class="bg-gray-100 font-semibold"><td class="px-6 py-3 text-left" colspan="5">${category}</td></tr>`;
                    categories[category].forEach(item => {
                        html += `
                        <tr>
                            <td class="px-6 py-3 text-left text-gray-700" colspan="4">${item.description}</td>
                            <td class="px-6 py-3 text-right font-medium">${formatCurrency(item.amount)}</td>
                        </tr>`;
                        categoryTotal += item.amount;
                    });
                    html += `
                        <tr class="font-semibold border-b-2 border-gray-200">
                            <td class="px-6 py-3 text-left" colspan="4">Total for ${category}</td>
                            <td class="px-6 py-3 text-right">${formatCurrency(categoryTotal)}</td>
                        </tr>`;
                }
            }
            tableBody.innerHTML = html;
        }

        function populateSubcontractors() {
            const subcontractorsListDiv = document.getElementById('subcontractors-list');
            subcontractorsListDiv.innerHTML = '';
            if (quoteData.subcontractors && quoteData.subcontractors.length > 0) {
                quoteData.subcontractors.forEach(sub => {
                    const subDiv = document.createElement('div');
                    subDiv.className = 'flex justify-between items-center pt-2';
                    subDiv.innerHTML = `
                        <p class="text-sm font-medium text-text-primary">${sub.contact_name || 'N/A'}</p>
                        <p class="text-sm text-text-secondary">${sub.contact_details || ''} - ${formatCurrency(sub.cost)}</p>
                    `;
                    subcontractorsListDiv.appendChild(subDiv);
                });
            } else {
                subcontractorsListDiv.innerHTML = '<p class="text-sm text-text-secondary">No subcontractors listed.</p>';
            }
        }

        function populateLaborTechs() {
            document.getElementById('display-labor-hours').textContent = `${quoteData.labor?.techHours || 0} hours`;
            document.getElementById('display-num-techs').textContent = `${quoteData.labor?.techCount || 0} techs`;
        }

        function updateDisplay() {
            if (!quoteData) return;

            // 1. Update content of dynamic sections
            populateSubcontractors();
            populateLaborTechs();

            // 2. Decide which table view to render
            const categoryBreakdownRadio = document.querySelector('input[name="display_option"][value="category"]');
            if (categoryBreakdownRadio && categoryBreakdownRadio.checked) {
                renderCategoryBreakdown();
            } else {
                renderSingleTotal();
            }

            // 3. Show/hide sections based on checkboxes
            const showParts = document.getElementById('show-parts').checked;
            const showSubcontractors = document.getElementById('show-subcontractors').checked;
            const showLabor = document.getElementById('show-labor-hours').checked;
            const showTechs = document.getElementById('show-num-techs').checked;

            document.getElementById('quote-table').closest('.border-t').style.display = showParts ? '' : 'none';
            document.getElementById('subcontractors-section').style.display = showSubcontractors ? '' : 'none';
            document.getElementById('labor-tech-section').style.display = (showLabor || showTechs) ? '' : 'none';
            document.getElementById('display-labor-hours').parentElement.style.display = showLabor ? '' : 'none';
            document.getElementById('display-num-techs').parentElement.style.display = showTechs ? '' : 'none';

            // 4. Update the main summary totals
            if (quoteData.summary) {
                const excludeSurcharge = document.getElementById('exclude-surcharge').checked;
                const surchargeAmount = excludeSurcharge ? 0 : parseCurrency(quoteData.summary.surcharge);

                const totals = {
                    parts: parseCurrency(quoteData.summary.partsTotal),
                    tech: parseCurrency(quoteData.summary.techLabor),
                    travel: parseCurrency(quoteData.summary.travelLabor),
                    sub: parseCurrency(quoteData.summary.subTotal),
                    seth: parseCurrency(quoteData.summary.sethFee),
                    surcharge: surchargeAmount
                };

                document.querySelector('[data-summary="parts-total"]').textContent = formatCurrency(totals.parts);
                document.querySelector('[data-summary="tech-labor"]').textContent = formatCurrency(totals.tech);
                document.querySelector('[data-summary="travel-labor"]').textContent = formatCurrency(totals.travel);
                document.querySelector('[data-summary="sub-total"]').textContent = formatCurrency(totals.sub);
                document.querySelector('[data-summary="seth-fee"]').textContent = formatCurrency(totals.seth);
                document.querySelector('[data-summary="surcharge"]').textContent = formatCurrency(totals.surcharge);

                const grandTotal = Object.values(totals).reduce((sum, value) => sum + value, 0);
                document.querySelector('[data-summary="grand-total"]').textContent = formatCurrency(grandTotal);
            }
        }

        // --- EXPORT FUNCTIONS ---
        function handleExport() {
            if (document.getElementById('check-pdf').checked) exportToPdf();
            if (document.getElementById('check-csv').checked) exportToCsv();
            if (document.getElementById('check-excel').checked) {
                alert('Excel export is not yet implemented. For now, you can open the CSV file in Excel.');
            }
        }

        function exportToPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const quotePreview = document.getElementById('quote-preview');
            const quoteTitle = quotePreview.querySelector('h3').textContent;
            const quoteDate = quotePreview.querySelector('p.mt-1').textContent;

            doc.setFontSize(18);
            doc.text(quoteTitle, 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(quoteDate, 14, 29);

            // Temporarily show all sections for PDF export
            const originalDisplays = {
                table: document.getElementById('quote-table').closest('.border-t').style.display,
                sub: document.getElementById('subcontractors-section').style.display,
                labor: document.getElementById('labor-tech-section').style.display
            };
            document.getElementById('quote-table').closest('.border-t').style.display = 'block';
            document.getElementById('subcontractors-section').style.display = 'block';
            document.getElementById('labor-tech-section').style.display = 'block';

            doc.autoTable({
                html: '#quote-table',
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [11, 128, 238] },
            });
            
            // Restore original display settings
            document.getElementById('quote-table').closest('.border-t').style.display = originalDisplays.table;
            document.getElementById('subcontractors-section').style.display = originalDisplays.sub;
            document.getElementById('labor-tech-section').style.display = originalDisplays.labor;

            doc.save(`${quoteTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
        }

        function getTableDataForCsv() {
            const table = document.getElementById('quote-table');
            const data = [];
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => headers.push(`"${th.textContent.trim()}"`));
            data.push(headers.join(','));

            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => row.push(`"${td.textContent.trim().replace(/"/g, '""')}"`));
                data.push(row.join(','));
            });
            return data.join('\r\n');
        }

        function exportToCsv() {
            const csvContent = getTableDataForCsv();
            const quoteTitle = document.querySelector('#quote-preview h3').textContent;
            const filename = `${quoteTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.csv`;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    });
</script>
</body></html>