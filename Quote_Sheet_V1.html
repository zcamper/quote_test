<!DOCTYPE html>
<html lang="en"><head><script type="text/javascript" src="/___vscode_livepreview_injected_script"></script><script type="text/javascript" src="/___vscode_livepreview_injected_script"></script>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com;">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title id="page-title">Quote Sheet</title>
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style type="text/tailwindcss">
        :root {
            --primary-color: #0c7ff2;
            --primary-hover-color: #0a6bcf;
            --background-color: #f7fafc;
            --text-primary: #1a202c;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --card-background: #ffffff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
        }
        .nav-link {
            font-size: 0.875rem;
            font-weight: 500;
            color: #4a5568;
            transition: color 0.2s;
        }
        .nav-link:hover {
            color: var(--primary-color);
        }
        .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #fff;
            background-color: var(--primary-color);
            transition: background-color 0.2s;
            outline: none;
            border: none;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover-color);
        }
        .btn-primary:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        .btn-secondary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #4a5568;
            background-color: #fff;
            border: 1px solid #d1d5db;
            transition: background-color 0.2s, color 0.2s;
            outline: none;
        }
        .btn-secondary:hover {
            background-color: #f9fafb;
        }
        .btn-secondary:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-sent {
            background-color: #bfdbfe;
            color: #1e40af;
        }
        .status-recalled {
            background-color: #fef9c3;
            color: #92400e;
        }
        .status-active {
            background-color: #bbf7d0;
            color: #166534;
        }
        .tab-active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-inactive:hover {
            color: #4a5568;
            border-color: #d1d5db;
        }
        .sidebar {
            float: right;
            width: 30%;
            padding: 10px;
            background-color: #f4f4f4;
        }
    </style>
</head>
<body data-new-gr-c-s-check-loaded="14.1248.0" data-gr-ext-installed="">
<div class="min-h-screen bg-[var(--background-color)]">
<header class="bg-white shadow-sm">
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
<div class="flex h-16 items-center justify-between">
<div class="flex items-center">
<div class="flex-shrink-0">
<svg class="h-8 w-8 text-[var(--primary-color)]" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M4 4H17.3334V17.3334H30.6666V30.6666H44V44H4V4Z" fill="currentColor"></path></svg>
</div>
<div class="hidden md:block">
<div class="ml-10 flex items-baseline space-x-4">
<a class="nav-link bg-gray-100 text-[var(--primary-color)] px-3 py-2 rounded-md" href="#">Dashboard</a>
<a class="nav-link" href="#">Quotes</a>
<a class="nav-link" href="#">Customers</a>
<a class="nav-link" href="#">Parts</a>
<a class="nav-link" href="#">Services</a>
<a class="nav-link" href="#">Reports</a>
</div>
</div>
</div>
<div class="hidden md:block">
<div class="ml-4 flex items-center md:ml-6">
<button class="rounded-full bg-white p-1 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" type="button">
<span class="material-icons">notifications</span>
</button>
<div class="relative ml-3">
<div>
<button aria-expanded="false" aria-haspopup="true" class="flex max-w-xs items-center rounded-full bg-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" id="user-menu-button" type="button">
<img alt="User avatar" class="h-8 w-8 rounded-full" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCrHFyF8INEihjjcDoXWZxlg33LCEXy5bjAB0y-q-_yPMMZe7IJvvVLYVS2fSwUF7c4JQFERtSKl1yAqmDoTfdDp0y7kxMLoYWbUYB51fefX0CqCe6O7x6dtQOdMC_FEnjnY6UEmMJRPdf3hUHTkOPHjZbYZxJP2Vh4Ip9kQ-ZBRyQ5gF7RTH3exLQjkmcePyLSOvZ8ZqILfjzFua19tYdbmF7RQ2ikLJaUOKtE5edWBrgW-8CiQLCWlgbWPHrWMOFb1tkzNwNNkX8">
</button>
</div>
</div>
</div>
</div>
</div>
</header>
<main>
<div class="mx-auto max-w-8xl py-6 sm:px-6 lg:px-8">
<div class="px-4 py-6 sm:px-0">
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6">
<div>
<h1 class="text-3xl font-bold tracking-tight text-[var(--text-primary)]">Quote Details</h1>
<p class="mt-1 text-sm text-[var(--text-secondary)]" id="quote-header-info">Quote Details</p>
</div>
<div class="mt-4 lg:mt-0 flex flex-wrap gap-2">
<button class="btn-secondary" id="clear-sheet-btn" type="button">
<span class="material-icons-outlined text-base mr-2">delete_sweep</span> Clear Sheet
</button>
<button class="btn-secondary" id="update-revision-btn" type="button" disabled="">
<span class="material-icons-outlined text-base mr-2">save</span> Update Revision
</button>
<button class="btn-secondary" id="save-revision-btn" type="button" disabled="">
<span class="material-icons-outlined text-base mr-2">save_as</span> Save as New Revision
</button>
<div class="relative inline-block text-left">
<div>
<button aria-expanded="true" aria-haspopup="true" class="btn-secondary group" id="menu-button" type="button">
<span class="material-icons-outlined text-base mr-2">download</span> Export
                                        <span class="material-icons-outlined text-base -mr-1 ml-2 h-5 w-5 text-gray-400 group-hover:text-gray-500">expand_more</span>
</button>
</div>
<div aria-labelledby="menu-button" aria-orientation="vertical" class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" tabindex="-1">
<div class="py-1" role="none">
<a class="text-gray-700 block px-4 py-2 text-sm" href="#" id="menu-item-0" role="menuitem" tabindex="-1">Export PDF</a>
<a class="text-gray-700 block px-4 py-2 text-sm" href="#" id="menu-item-1" role="menuitem" tabindex="-1">Export CSV (All)</a>
<a class="text-gray-700 block px-4 py-2 text-sm" href="#" id="menu-item-2" role="menuitem" tabindex="-1">Export CSV (By Vendor)</a>
</div>
</div>
</div>
<button class="btn-primary" id="finalize-send-btn" type="button">
<span class="material-icons-outlined text-base mr-2">send</span> Finalize &amp; Send
                            </button>
</div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-5 gap-10">

<div class="lg:col-span-1 space-y-6">
<div class="bg-white shadow-sm rounded-lg">
<div class="p-6">
<h3 class="text-lg font-semibold leading-6 text-[var(--text-primary)]">Service Call</h3>
<div class="mt-4">
<label class="text-xs text-gray-500" for="service-call-id">Service Call ID</label>
<div class="flex items-center space-x-2">
<input class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" id="service-call-id" placeholder="yymmdd-xxxx" type="text">
<button class="btn-secondary flex-shrink-0" id="import-btn" type="button">
<span class="material-icons-outlined text-base mr-1">download</span> Import
</button>
<div class="relative">
<select class="rounded-md border-gray-300 shadow-sm sm:text-sm pr-8" disabled="" id="revision-selector">
<option>Rev</option>
</select>
</div>
</div>
</div>
</div>
</div>
<div class="bg-white shadow-sm rounded-lg">
    <div class="p-6">
        <h3 class="text-lg font-semibold leading-6 text-[var(--text-primary)] mb-4">Unit Location</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            <div class="break-words">
                <p class="text-base font-semibold text-[var(--text-primary)]" id="unit-location-name">Sophia Carter</p>
                <p class="text-sm text-[var(--text-secondary)]" id="unit-location-company">Acme Corporation</p>
            </div>
            <div class="break-words">
                <p class="text-sm text-[var(--text-secondary)]" id="unit-location-address-1">123 Industrial Way</p>
                <p class="text-sm text-[var(--text-secondary)]" id="unit-location-address-2">Springfield, IL 62704</p>
                <p class="text-sm text-[var(--text-secondary)]" id="unit-location-email">scarter@acmecorp.com</p>
            </div>
        </div>
    </div>
</div>
<div class="bg-white shadow-sm rounded-lg">
    <div class="p-6">
        <h3 class="grid grid-cols-2 md:grid-cols-2 gap-x-6 text-lg font-semibold leading-6 text-[var(--text-primary)] mb-4">Bill to Customer</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            <div class="break-words">
                <p class="text-base font-semibold text-[var(--text-primary)]" id="bill-to-name">Sophia Carter</p>
                <p class="text-sm text-[var(--text-secondary)]" id="bill-to-company">Acme Corporation</p>
            </div>
            <div class="break-words">
                <p class="text-sm text-[var(--text-secondary)]" id="bill-to-address-1">123 Industrial Way</p>
                <p class="text-sm text-[var(--text-secondary)]" id="bill-to-address-2">Springfield, IL 62704</p>
                <p class="text-sm text-[var(--text-secondary)]" id="bill-to-email">scarter@acmecorp.com</p>
            </div>
        </div>
    </div>
</div>
<div class="bg-white shadow-sm rounded-lg">
<div class="p-6">
<h3 class="text-lg font-semibold leading-6 text-[var(--text-primary)]">Unit Information</h3>
</div>
<div class="border-t border-[var(--border-color)]">
<div class="divide-y divide-[var(--border-color)]">
<div class="px-6 py-4">
<h4 class="text-base font-semibold text-gray-800">Generator</h4>
<div class="mt-2 grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
<div class="text-[var(--text-secondary)]">Model:</div><div class="text-[var(--text-primary)] font-medium unit-info-value" data-key="generator.model">PowerPro 2000X</div>
<div class="text-[var(--text-secondary)]">Serial:</div><div class="text-[var(--text-primary)] font-medium unit-info-value" data-key="generator.serial">PP2KX-987654</div>
<div class="text-[var(--text-secondary)]">Spec:</div><div class="text-[var(--text-primary)] font-medium unit-info-value" data-key="generator.spec">A</div>
<div class="text-[var(--text-secondary)]">KW:</div><div class="text-[var(--text-primary)] font-medium unit-info-value" data-key="generator.kw">150</div>
<div class="text-[var(--text-secondary)]">Voltage:</div><div class="text-[var(--text-primary)] font-medium unit-info-value" data-key="generator.voltage">480V 3P</div>
<div class="text-[var(--text-secondary)]">Warranty:</div><div class="text-[var(--text-primary)] font-medium text-green-600 unit-info-value" data-key="generator.warranty">Active until 12/2025</div>
</div>
</div>
<div class="px-6 py-4">
<h4 class="text-base font-semibold text-gray-800">ATS</h4>
<div class="mt-2 grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
<div class="text-[var(--text-secondary)]">Model:</div><div class="text-[var(--text-primary)] font-medium unit-info-value" data-key="ats.model">SwitchGuard 300</div>
<div class="text-[var(--text-secondary)]">Serial:</div><div class="text-[var(--text-primary)] font-medium unit-info-value" data-key="ats.serial">SG300-123456</div>
</div>
</div>
<div class="px-6 py-4">
<h4 class="text-base font-semibold text-gray-800">Engine</h4>
<div class="mt-2 grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
<div class="text-[var(--text-secondary)]">Model:</div><div class="text-[var(--text-primary)] font-medium unit-info-value" data-key="engine.model">DieselMax 6.7L</div>
<div class="text-[var(--text-secondary)]">Serial:</div><div class="text-[var(--text-primary)] font-medium unit-info-value" data-key="engine.serial">DM67L-543210</div>
</div>
</div>
</div>
</div>
</div>

<div class="lg:col-span-3 space-y-6">
<div class="bg-[var(--card-background)] shadow-sm rounded-lg overflow-hidden">
<div class="p-6">
<h3 class="text-lg font-semibold leading-6 text-[var(--text-primary)]">Service Call Write-up</h3>
<div class="mt-2">
<textarea class="block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" id="service-call-writeup" placeholder="Service call write-up will be imported here..." readonly="" rows="4"></textarea>
</div>
</div>
<div class="border-t border-[var(--border-color)] p-6">
<div class="flex justify-between items-center">
<h3 class="text-lg font-semibold leading-6 text-[var(--text-primary)]">Quote Description</h3>
<button class="btn-secondary text-sm" id="generate-summary-btn" type="button"><span class="material-icons-outlined text-base mr-2">auto_awesome</span>Generate with AI</button>
</div>
<div class="mt-2">
<textarea class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" id="quote-description-textarea" placeholder="Enter a description for this quote..." rows="3">Standard service and parts replacement for Unit 5 compressor failure. Includes diagnostics, parts, and labor.</textarea>
</div>
</div>
<div class="border-t border-[var(--border-color)] grid grid-cols-1 md:grid-cols-2 gap-6 p-6">
<div data-rate="75" id="tech-labor-section">
<h3 class="text-sm font-medium text-[var(--text-secondary)]">Technician Labor ($<span id="tech-rate-display">75</span>/hr)</h3>
<div class="mt-1 grid grid-cols-2 gap-2">
<div>
<label class="text-xs text-gray-500" for="tech-count"># Techs</label>
<input class="labor-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" id="tech-count" type="number" value="2">
</div>
<div>
<label class="text-xs text-gray-500" for="tech-hours">Hours</label>
<input class="labor-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" id="tech-hours" type="number" value="8">
</div>
</div>
</div>
<div data-rate="75" id="travel-labor-section">
<h3 class="text-sm font-medium text-[var(--text-secondary)]">Travel Labor ($<span id="travel-rate-display">75</span>/hr)</h3>
<div class="mt-1">
<label class="text-xs text-gray-500" for="travel-hours">Hours</label>
<input class="labor-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" id="travel-hours" type="number" value="4">
</div>
</div>
</div>
<div class="border-t border-[var(--border-color)] grid grid-cols-1 md:grid-cols-2 gap-6 p-6">
<div>
<h3 class="text-sm font-medium text-[var(--text-secondary)]">S.E.T.H. Fee (%)</h3>
<input class="fee-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" id="seth-fee-percentage" type="number" value="1.5">
</div>
<div>
<h3 class="text-sm font-medium text-[var(--text-secondary)]">Fuel & Material Surcharge ($)</h3>
<input class="fee-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" id="surcharge-amount" type="number" value="75.00">
</div>
</div>
<div class="border-t border-[var(--border-color)]">
<div class="px-6 pt-5 pb-4">
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
<h3 class="text-lg font-semibold leading-6 text-[var(--text-primary)]">Parts</h3>
<div class="mt-3 sm:mt-0 flex items-center space-x-2">
<button class="btn-secondary" id="add-part-btn" type="button">
<span class="material-icons-outlined text-base mr-2">add</span> Add Part
</button>
<div class="relative inline-block text-left">
<button class="btn-secondary group" id="load-template-btn" type="button">
<span class="material-icons-outlined text-base mr-2">file_download</span> Load from Template
                                    <span class="material-icons-outlined text-base -mr-1 ml-2 h-5 w-5 text-gray-400 group-hover:text-gray-500">expand_more</span>
</button>
</div>
<button class="btn-secondary" id="save-template-btn" type="button">
<span class="material-icons-outlined text-base mr-2">save_as</span> Save as Template
</button>
</div>
</div>
<div class="relative">
<div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
<span class="material-icons-outlined text-gray-400">search</span>
</div>
<input id="parts-search" name="parts-search" class="block w-full rounded-md border-gray-300 pl-10 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Search by Part # or Name" type="text">
</div>
</div>
<div class="flow-root">
<div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
<div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-20">
<table class="min-w-full divide-y divide-[var(--border-color)] table-fixed" id="parts-table">
<thead>
    <tr class="text-left text-sm font-semibold text-[var(--text-primary)]">
        <th scope="col" class="py-3.5 pl-4 pr-6 sm:pl-0 w-2/6">KPS Number / Description</th>
        <th scope="col" class="px-6 py-3.5 w-1/6">Vendor Part # / Vendor</th>
        <th scope="col" class="px-6 py-3.5 text-right w-1/6">List / Unit Cost</th>
        <th scope="col" class="px-6 py-3.5 text-right w-1/6">Qty</th>
        <th scope="col" class="px-6 py-3.5 text-right w-1/6">Total</th>
        <th scope="col" class="relative py-3.5 pl-6 pr-4 sm:pr-0"><span class="sr-only">Delete</span></th>
    </tr>
</thead>
<tbody class="divide-y divide-[var(--border-color)] bg-white">
    <tr>
        <td class="py-2 pl-4 pr-6 text-sm sm:pl-0 break-words align-top">
            <div class="font-medium text-[var(--text-primary)]">CM-203A</div>
            <div class="mt-1"><input id="desc-1" name="desc-1" class="desc-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Description" type="text" value="Compressor Motor"></div>
        </td>
        <td class="px-6 py-2 text-sm break-words align-top">
            <div><input id="vendor-part-1" name="vendor-part-1" class="vendor-part-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Vendor Part #" type="text" value=""></div>
            <div class="mt-1"><input id="vendor-1" name="vendor-1" class="vendor-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Vendor" type="text" value="Global Parts"></div>
        </td>
        <td class="px-6 py-2 text-sm text-right align-top">
            <div><input id="list-price-1" name="list-price-1" class="list-price-input w-24 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" step="0.01" type="number" value="500.00"></div>
            <div class="mt-1"><input id="unit-cost-1" name="unit-cost-1" class="unit-cost-input w-24 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" step="0.01" type="number" value="450.00"></div>
        </td>
        <td class="px-6 py-2 text-sm text-right align-top">
            <input id="qty-1" name="qty-1" class="qty-input w-20 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" type="number" value="1">
        </td>
        <td class="row-total px-6 py-2 text-sm font-medium text-right text-[var(--text-primary)] align-top">$450.00</td>
        <td class="py-2 pl-6 pr-4 text-right text-sm font-medium sm:pr-0 align-top">
            <button class="text-red-600 hover:text-red-900 delete-part-btn" type="button"><span class="material-icons-outlined text-base">delete</span></button>
        </td>
    </tr>
    <tr>
        <td class="py-2 pl-4 pr-6 text-sm sm:pl-0 break-words align-top">
            <div class="font-medium text-[var(--text-primary)]">FLT-55B</div>
            <div class="mt-1"><input id="desc-2" name="desc-2" class="desc-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Description" type="text" value="Filter Drier"></div>
        </td>
        <td class="px-6 py-2 text-sm break-words align-top">
            <div><input id="vendor-part-2" name="vendor-part-2" class="vendor-part-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Vendor Part #" type="text" value=""></div>
            <div class="mt-1"><input id="vendor-2" name="vendor-2" class="vendor-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Vendor" type="text" value="ACME Filters"></div>
        </td>
        <td class="px-6 py-2 text-sm text-right align-top">
            <div><input id="list-price-2" name="list-price-2" class="list-price-input w-24 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" step="0.01" type="number" value="45.00"></div>
            <div class="mt-1"><input id="unit-cost-2" name="unit-cost-2" class="unit-cost-input w-24 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" step="0.01" type="number" value="35.00"></div>
        </td>
        <td class="px-6 py-2 text-sm text-right align-top">
            <input id="qty-2" name="qty-2" class="qty-input w-20 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" type="number" value="1">
        </td>
        <td class="row-total px-6 py-2 text-sm font-medium text-right text-[var(--text-primary)] align-top">$35.00</td>
        <td class="py-2 pl-6 pr-4 text-right text-sm font-medium sm:pr-0 align-top">
            <button class="text-red-600 hover:text-red-900 delete-part-btn" type="button"><span class="material-icons-outlined text-base">delete</span></button>
        </td>
    </tr>
    <tr>
        <td class="py-2 pl-4 pr-6 text-sm sm:pl-0 break-words align-top">
            <div class="font-medium text-[var(--text-primary)]">REF-R410A</div>
            <div class="mt-1"><input id="desc-3" name="desc-3" class="desc-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Description" type="text" value="Refrigerant (10 lbs)"></div>
        </td>
        <td class="px-6 py-2 text-sm break-words align-top">
            <div><input id="vendor-part-3" name="vendor-part-3" class="vendor-part-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Vendor Part #" type="text" value=""></div>
            <div class="mt-1"><input id="vendor-3" name="vendor-3" class="vendor-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Vendor" type="text" value="Global Parts"></div>
        </td>
        <td class="px-6 py-2 text-sm text-right align-top">
            <div><input id="list-price-3" name="list-price-3" class="list-price-input w-24 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" step="0.01" type="number" value="150.00"></div>
            <div class="mt-1"><input id="unit-cost-3" name="unit-cost-3" class="unit-cost-input w-24 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" step="0.01" type="number" value="120.00"></div>
        </td>
        <td class="px-6 py-2 text-sm text-right align-top">
            <input id="qty-3" name="qty-3" class="qty-input w-20 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" type="number" value="1">
        </td>
        <td class="row-total px-6 py-2 text-sm font-medium text-right text-[var(--text-primary)] align-top">$120.00</td>
        <td class="py-2 pl-6 pr-4 text-right text-sm font-medium sm:pr-0 align-top">
            <button class="text-red-600 hover:text-red-900 delete-part-btn" type="button"><span class="material-icons-outlined text-base">delete</span></button>
        </td>
    </tr>
</tbody>
<tfoot>
    <tr>
        <th scope="row" colspan="4" class="hidden pl-4 pr-3 pt-4 text-right text-sm font-semibold text-[var(--text-primary)] sm:table-cell sm:pl-0">Parts Total</th>
        <th scope="row" class="pl-4 pr-3 pt-4 text-left text-sm font-semibold text-[var(--text-primary)] sm:hidden">Parts Total</th>
        <td class="pl-3 pr-4 pt-4 text-right text-sm font-semibold text-[var(--text-primary)] sm:pr-0">$605.00</td>
    </tr>
</tfoot>
</table>
</div>
</div>
</div>
</div>
<div class="border-t border-[var(--border-color)] px-6 py-5">
<div class="flex justify-between items-center">
<h3 class="text-lg font-semibold leading-6 text-[var(--text-primary)]">Subcontractors</h3>
<button class="btn-secondary" id="add-subcontractor-btn" type="button">
<span class="material-icons-outlined text-base mr-2">add</span> Add Subcontractor
                                </button>
</div>
<div class="mt-4 space-y-4" id="subcontractors-list">
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end p-4 border border-gray-200 rounded-lg">
<div class="md:col-span-2">
<label class="text-sm font-medium text-[var(--text-secondary)]" for="subcontractor-contact-1">Subcontractor Contact</label>
<input class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" id="subcontractor-contact-1" placeholder="Name or Company" type="text" value="Crane Services Inc.">
</div>
<div>
<label class="text-sm font-medium text-[var(--text-secondary)]" for="subcontractor-details-1">Contact Details</label>
<input class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" id="subcontractor-details-1" type="text" placeholder="Email or Phone" value="">
</div>
<div>
<label class="text-sm font-medium text-[var(--text-secondary)]" for="subcontractor-cost-1">Cost</label>
<div class="relative mt-1">
<div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
<span class="text-gray-500 sm:text-sm">$</span>
</div>
<input class="block w-full rounded-md border-gray-300 pl-7 pr-12 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" id="subcontractor-cost-1" name="subcontractor-cost-1" placeholder="0.00" type="text" value="850.00">
</div>
</div>
</div>
</div>
</div>
</div>

<div class="lg:col-span-1 space-y-6">
<div class="bg-white shadow-sm rounded-lg">
<div class="px-6 py-5">
<div class="max-w-xl">
<h3 class="text-lg font-semibold leading-6 text-[var(--text-primary)] mb-4">Quote Summary</h3>
<div class="space-y-3">
<div class="flex justify-between items-center">
<p class="text-sm text-[var(--text-secondary)]">Parts Total</p><p class="summary-value text-sm font-medium text-[var(--text-primary)]" data-summary="parts-total">$605.00</p>
</div>
<div class="flex justify-between items-center">
<p class="text-sm text-[var(--text-secondary)]">Technician Labor</p><p class="summary-value text-sm font-medium text-[var(--text-primary)]" data-summary="tech-labor">$1200.00</p>
</div>
<div class="flex justify-between items-center">
<p class="text-sm text-[var(--text-secondary)]">Travel Labor</p><p class="summary-value text-sm font-medium text-[var(--text-primary)]" data-summary="travel-labor">$300.00</p>
</div>
<div class="flex justify-between items-center">
<p class="text-sm text-[var(--text-secondary)]">Subcontractor Total</p><p class="summary-value text-sm font-medium text-[var(--text-primary)]" data-summary="sub-total">$850.00</p>
</div>
<div class="flex justify-between items-center">
<p class="text-sm text-[var(--text-secondary)]">S.E.TH Fee (1.5%)</p><p class="summary-value text-sm font-medium text-[var(--text-primary)]" data-summary="seth-fee">$44.32</p>
</div>
<div class="flex justify-between items-center">
<p class="text-sm text-[var(--text-secondary)]">Fuel &amp; Material Surcharge</p><p class="summary-value text-sm font-medium text-[var(--text-primary)]" data-summary="surcharge">$75.00</p>
</div>
<div class="flex justify-between items-center pt-4 border-t border-dashed border-gray-300">
<p class="text-base font-semibold text-[var(--text-primary)]">Grand Total</p>
<p class="summary-value text-2xl font-bold text-[var(--primary-color)]" data-summary="grand-total">$3074.32</p>
</div>
</div>
</div>
</div>
</div>
<div class="bg-white shadow-sm rounded-lg">
    <div class="p-6">
        <h3 class="text-lg font-semibold leading-6 text-[var(--text-primary)]">On Hand Inventory</h3>
        <ul class="mt-4 space-y-2 divide-y divide-gray-100">
            <li class="flex justify-between items-center pt-2">
                <p class="text-sm font-medium text-[var(--text-primary)]">CM-203A</p>
                <p class="text-sm font-medium text-green-600">5</p>
            </li>
            <li class="flex justify-between items-center pt-2">
                <p class="text-sm font-medium text-[var(--text-primary)]">FLT-55B</p>
                <p class="text-sm font-medium text-green-600">12</p>
            </li>
            <li class="flex justify-between items-center pt-2">
                <p class="text-sm font-medium text-[var(--text-primary)]">REF-R410A</p>
                <p class="text-sm font-medium text-red-600">0</p>
            </li>
        </ul>
    </div>
</div>
</div>
</div>
</div>
</main>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const { jsPDF } = window.jspdf;
    // --- STATE MANAGEMENT ---
    let quoteState = { serviceCallId: null, revision: null, revisions: [] };

    // --- HELPER FUNCTIONS ---

    // Toggles the visibility of a dropdown menu
    function setupMenuButton(buttonId) {
        const menuButton = document.getElementById(buttonId);
        if (!menuButton) return;
        const menu = menuButton.closest('div').nextElementSibling;
        menuButton.addEventListener('click', () => {
            menu.classList.toggle('hidden');
        });
        document.addEventListener('click', (event) => {
            if (menu && !menu.classList.contains('hidden') && !menuButton.contains(event.target) && !menu.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });
    }

    // Switches between content tabs
    function setupTabs(tab1Id, tab2Id, panel1Id, panel2Id) {
        const tab1 = document.getElementById(tab1Id);
        const tab2 = document.getElementById(tab2Id);
        const panel1 = document.getElementById(panel1Id);
        const panel2 = document.getElementById(panel2Id);

        function switchTabs(activeTab, inactiveTab, activePanel, inactivePanel) {
            activeTab.classList.remove('tab-inactive');
            activeTab.classList.add('tab-active');
            inactiveTab.classList.remove('tab-active');
            inactiveTab.classList.add('tab-inactive');
            activePanel.classList.remove('hidden');
            inactivePanel.classList.add('hidden');
        }

        if (tab1) tab1.addEventListener('click', () => switchTabs(tab1, tab2, panel1, panel2));
        if (tab2) tab2.addEventListener('click', () => switchTabs(tab2, tab1, panel2, panel1));
    }

    // --- DATA & ACTION FUNCTIONS ---

    function getTableRowsForExport() {
        return Array.from(document.querySelectorAll('#parts-table tbody tr')).map(tr => {
            const cells = Array.from(tr.cells);
            const getCellContent = (cellIndex, inputSelector = null) => {
                const cell = cells[cellIndex];
                if (!cell) return '';
                if (inputSelector) {
                    const input = cell.querySelector(inputSelector);
                    if (input) return input.value;
                }
                return cell.textContent.trim();
            };

            return [
                getCellContent(0, 'input'), // Part #
                getCellContent(1, 'input'), // Description
                getCellContent(2, 'input'), // Vendor
                getCellContent(3), // On Hand
                getCellContent(4, '.qty-input'), // Qty
                `$${parseFloat(getCellContent(5, '.unit-cost-input') || '0').toFixed(2)}`, // Unit Cost
                getCellContent(6) // Total Cost
            ];
        });
    }

    function exportToPdf() {
        const doc = new jsPDF();
        doc.text("Quote Details: #"+(quoteState.serviceCallId || 'N/A'), 14, 22);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Customer: ${document.querySelector('.p-6 .font-semibold').textContent}`, 14, 29);

        const head = [Array.from(document.querySelectorAll('#parts-table thead th'))
                           .map(th => th.textContent)
                           .slice(0, -1) // Exclude delete column
                     ];
        const body = getTableRowsForExport();

        doc.autoTable({
            head: head,
            body: body,
            startY: 40,
            headStyles: { fillColor: [12, 127, 242] }, // --primary-color
            styles: { cellPadding: 2, fontSize: 8 },
        });
        doc.save('quote.pdf');
    }

    function exportToCsv(filename, rows) {
        const table = document.getElementById('parts-table');
        if (!table) return;
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => `"${th.textContent.trim()}"`);
        let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\r\n";
        rows.forEach(rowArray => {
            csvContent += rowArray.join(",") + "\r\n";
        });
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function getPartsDataForSave() {
        return Array.from(document.querySelectorAll('#parts-table tbody tr')).map(tr => {
            const partCell = tr.cells[0];
            // A new row has an input for part #, existing ones have text.
            const partNumber = (partCell.querySelector('input')?.value || partCell.textContent).trim();

            return {
                part: partNumber,
                desc: tr.querySelector('.desc-input')?.value,
                vendor: tr.querySelector('.vendor-input')?.value,
                onHand: tr.cells[3].textContent.trim(),
                qty: tr.querySelector('.qty-input')?.value,
                unitCost: tr.querySelector('.unit-cost-input')?.value,
            };
        });
    }

    function addSubcontractor(subData = {}) {
        const list = document.getElementById('subcontractors-list');
        if (!list) return;
        const count = list.children.length + 1;
        const newSub = document.createElement('div');
        newSub.className = 'grid grid-cols-1 md:grid-cols-4 gap-4 items-end p-4 border border-gray-200 rounded-lg';

        const contact = subData.contact_name || '';
        const details = subData.contact_details || '';
        const cost = subData.cost || '';

        newSub.innerHTML = `
            <div class="md:col-span-2">
                <label class="text-sm font-medium text-[var(--text-secondary)]" for="subcontractor-contact-${count}">Subcontractor Contact</label>
                <input class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" id="subcontractor-contact-${count}" placeholder="Name or Company" type="text" value="${contact}"/>
            </div>
            <div>
                <label class="text-sm font-medium text-[var(--text-secondary)]" for="subcontractor-details-${count}">Contact Details</label>
                <input class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" id="subcontractor-details-${count}" placeholder="Email or Phone" type="text" value="${details}"/>
            </div>
            <div>
                <label class="text-sm font-medium text-[var(--text-secondary)]" for="subcontractor-cost-${count}">Cost</label>
                <div class="relative mt-1">
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">$</span></div>
                    <input class="block w-full rounded-md border-gray-300 pl-7 pr-12 shadow-sm sm:text-sm" id="subcontractor-cost-${count}" name="subcontractor-cost-${count}" placeholder="0.00" type="text" value="${cost}"/>
                </div>
            </div>`;
        list.appendChild(newSub);
        // Add listener to the new cost input and recalculate totals.
        newSub.querySelector('input[id^="subcontractor-cost-"]').addEventListener('input', updateTotals);
        updateTotals(); // This is needed for both manual add and for populating
    }

    function addPartRow() {
        const tableBody = document.querySelector('#parts-table tbody');
        if (!tableBody) return;

        const newRow = tableBody.insertRow();
        newRow.innerHTML = `
            <td class="whitespace-nowrap py-2 pl-4 pr-3 text-sm sm:pl-0"><input type="text" placeholder="Part #" class="part-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm"/></td>
            <td class="whitespace-nowrap px-3 py-2 text-sm"><input type="text" placeholder="Description" class="desc-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm"/></td>
            <td class="whitespace-nowrap px-3 py-2 text-sm"><input type="text" placeholder="Vendor" class="vendor-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm"/></td>
            <td class="whitespace-nowrap px-3 py-2 text-sm text-gray-500 font-medium">N/A</td>
            <td class="whitespace-nowrap px-3 py-2 text-sm"><input class="qty-input w-20 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" type="number" value="1"/></td>
            <td class="whitespace-nowrap px-3 py-2 text-sm"><input class="unit-cost-input w-24 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" step="0.01" type="number" value="0.00"/></td>
            <td class="row-total whitespace-nowrap px-3 py-2 text-sm text-right font-medium text-[var(--text-primary)]">$0.00</td>
            <td class="whitespace-nowrap py-2 pl-3 pr-4 text-right text-sm font-medium sm:pr-0"><button type="button" class="text-red-600 hover:text-red-900 delete-part-btn"><span class="material-icons-outlined text-base">delete</span></button></td>
        `;
        newRow.querySelectorAll('.qty-input, .unit-cost-input').forEach(input => input.addEventListener('input', updateTotals));
        newRow.querySelector('input').focus();
    }

    // --- DYNAMIC CALCULATION & UI UPDATES ---

    function formatCurrency(value) {
        return `$${Number(value).toFixed(2)}`;
    }

    function parseCurrency(value) {
        return parseFloat(String(value).replace('$', '')) || 0;
    }

    function updateTotals() {
        // 1. Calculate Parts Total
        let partsTotal = 0;
        document.querySelectorAll('#parts-table tbody tr').forEach(row => {
            const qty = parseFloat(row.querySelector('.qty-input')?.value) || 0;
            const unitCost = parseFloat(row.querySelector('.unit-cost-input')?.value) || 0;
            const rowTotal = qty * unitCost;
            
            const totalCell = row.querySelector('.row-total');
            if (totalCell) totalCell.textContent = formatCurrency(rowTotal);
            
            partsTotal += rowTotal;
        });

        // 2. Calculate Subcontractor Total
        let subcontractorTotal = 0;
        document.querySelectorAll('#subcontractors-list input[id^="subcontractor-cost-"]').forEach(input => {
            subcontractorTotal += parseFloat(input.value) || 0;
        });

        // 3. Calculate Labor Costs
        const techCount = parseFloat(document.getElementById('tech-count')?.value) || 0;
        const techHours = parseFloat(document.getElementById('tech-hours')?.value) || 0;
        const techRate = parseFloat(document.getElementById('tech-labor-section')?.dataset.rate) || 75;
        const techLabor = techCount * techHours * techRate;

        const travelHours = parseFloat(document.getElementById('travel-hours')?.value) || 0;
        const travelRate = parseFloat(document.getElementById('travel-labor-section')?.dataset.rate) || 75;
        const travelLabor = travelHours * travelRate;

        const surcharge = parseCurrency(document.querySelector('.summary-value[data-summary="surcharge"]')?.textContent);

        // 4. Calculate derived totals
        const subtotalForFee = partsTotal + techLabor + travelLabor + subcontractorTotal;
        const sethFee = subtotalForFee * 0.015;
        const grandTotal = subtotalForFee + sethFee + surcharge;

        // 5. Update UI
        // Table footer
        document.querySelector('#parts-table tfoot td').textContent = formatCurrency(partsTotal);
        // Summary section
        document.querySelector('.summary-value[data-summary="parts-total"]').textContent = formatCurrency(partsTotal);
        document.querySelector('.summary-value[data-summary="tech-labor"]').textContent = formatCurrency(techLabor);
        document.querySelector('.summary-value[data-summary="travel-labor"]').textContent = formatCurrency(travelLabor);
        document.querySelector('.summary-value[data-summary="sub-total"]').textContent = formatCurrency(subcontractorTotal);
        document.querySelector('.summary-value[data-summary="seth-fee"]').textContent = formatCurrency(sethFee);
        document.querySelector('.summary-value[data-summary="grand-total"]').textContent = formatCurrency(grandTotal);
    }

    function resetImportedFields() {
        // Reset state
        quoteState = { serviceCallId: null, revision: null, revisions: [] };
        const revisionSelector = document.getElementById('revision-selector');
        revisionSelector.innerHTML = '<option>No Revisions</option>';
        revisionSelector.disabled = true;
        document.getElementById('update-revision-btn').disabled = true;
        document.getElementById('save-revision-btn').disabled = true;
        // Reset customer to placeholder
        const writeupEl = document.getElementById('service-call-writeup');
        if (writeupEl) {
            writeupEl.value = '';
        }
        document.getElementById('customer-name').textContent = 'Sophia Carter';
        document.getElementById('customer-company').textContent = 'Acme Corporation';

        // Reset rates to default
        const techLaborSection = document.getElementById('tech-labor-section');
        techLaborSection.dataset.rate = '75';
        document.getElementById('tech-rate-display').textContent = '75';
        const travelLaborSection = document.getElementById('travel-labor-section');
        travelLaborSection.dataset.rate = '75';
        document.getElementById('travel-rate-display').textContent = '75';

        // Reset unit info to default
        const defaultUnitInfo = {
            "generator.model": "PowerPro 2000X", "generator.serial": "PP2KX-987654",
            "generator.spec": "A", "generator.kw": "150", "generator.voltage": "480V 3P",
            "generator.warranty": "Active until 12/2025", "ats.model": "SwitchGuard 300",
            "ats.serial": "SG300-123456", "engine.model": "DieselMax 6.7L", "engine.serial": "DM67L-543210"
        };
        document.querySelectorAll('.unit-info-value').forEach(el => {
            const key = el.dataset.key;
            el.textContent = defaultUnitInfo[key] || 'N/A';
            el.classList.remove('text-green-600', 'text-red-600');
            if (key === 'generator.warranty') {
                el.classList.add(String(el.textContent).startsWith('Active') ? 'text-green-600' : 'text-red-600');
            }
        });

        updateTotals();
    }

    function clearSheet() {
        if (!confirm('Are you sure you want to clear the entire quote sheet? This cannot be undone.')) {
            return;
        }
        document.getElementById('quote-description-textarea').value = '';
        document.getElementById('service-call-id').value = '';
        document.getElementById('tech-count').value = '0';
        document.getElementById('tech-hours').value = '0';
        document.getElementById('travel-hours').value = '0';
        resetImportedFields();
        const partsTableBody = document.querySelector('#parts-table tbody');
        if (partsTableBody) partsTableBody.innerHTML = '';
        const subcontractorsList = document.getElementById('subcontractors-list');
        if (subcontractorsList) subcontractoresList.innerHTML = '';
        document.querySelectorAll('.unit-info-value').forEach(el => {
            el.textContent = 'N/A';
            el.classList.remove('text-green-600');
        });
        updateTotals();
    }

    // --- SERVICE CALL IMPORT LOGIC ---

    // This function simulates fetching data from your backend.
    async function fetchServiceCallData(id) {
        console.log(`Fetching data for Service Call ID: ${id}...`);
        try {
            const response = await fetch(`/api/service-call/${id}`);
            if (response.status === 404) {
                return null; // Service call not found in ERP
            }
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            return await response.json(); // The API now returns an object { revisions: [...], baseData: ... }
        } catch (error) {
            console.error("API call failed:", error);
            alert("Could not connect to the backend service. Please ensure it is running.");
            return null;
        }
    }
    
    function populateBaseData(baseData) {
        const { customer, unitInfo, rates, writeup } = baseData;

        // Populate customer info
        document.getElementById('customer-name').textContent = customer.name;
        document.getElementById('customer-company').textContent = customer.company;

        // Populate write-up
        const writeupEl = document.getElementById('service-call-writeup');
        if (writeupEl) {
            writeupEl.value = writeup || '';
        }

        // Populate rates
        const defaultRates = rates || { tech: 75, travel: 75 };
        const techLaborSection = document.getElementById('tech-labor-section');
        techLaborSection.dataset.rate = defaultRates.tech;
        document.getElementById('tech-rate-display').textContent = Number(defaultRates.tech).toFixed(2);
        const travelLaborSection = document.getElementById('travel-labor-section');
        travelLaborSection.dataset.rate = defaultRates.travel;
        document.getElementById('travel-rate-display').textContent = Number(defaultRates.travel).toFixed(2);

        // Populate unit info
        document.querySelectorAll('.unit-info-value').forEach(el => {
            const key = el.dataset.key;
            el.textContent = unitInfo[key] || 'N/A';
            el.classList.remove('text-green-600', 'text-red-600');
            if (key === 'generator.warranty') {
                el.classList.add(String(el.textContent).startsWith('Active') ? 'text-green-600' : 'text-red-600');
            }
        });
    }

    function populateQuoteWithData(revisionData) {
        const { parts, description, tech_count, tech_hours, travel_hours, subcontractors } = revisionData;

        // Populate description
        document.getElementById('quote-description-textarea').value = description || '';

        // Populate labor
        document.getElementById('tech-count').value = tech_count || 0;
        document.getElementById('tech-hours').value = tech_hours || 0;
        document.getElementById('travel-hours').value = travel_hours || 0;

        // Populate parts table
        const tableBody = document.querySelector('#parts-table tbody');
        tableBody.innerHTML = ''; // Clear existing parts
        if (parts && parts.length > 0) {
            parts.forEach(part => {
                const onHand = part.onHand || 'N/A';
                const onHandClass = isNaN(parseInt(onHand)) || parseInt(onHand) > 0 ? 'text-green-600' : 'text-red-600';
                const newRow = tableBody.insertRow();
                newRow.innerHTML = `
                    <td class="whitespace-nowrap py-2 pl-4 pr-3 text-sm font-medium text-[var(--text-primary)] sm:pl-0">${part.part || ''}</td>
                    <td class="whitespace-nowrap px-3 py-2 text-sm"><input class="desc-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm" type="text" value="${part.desc || ''}" placeholder="Description"></td>
                    <td class="whitespace-nowrap px-3 py-2 text-sm"><input class="vendor-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm" type="text" value="${part.vendor || ''}" placeholder="Vendor"></td>
                    <td class="whitespace-nowrap px-3 py-2 text-sm ${onHandClass} font-medium">${onHand}</td>
                    <td class="whitespace-nowrap px-3 py-2 text-sm"><input class="qty-input w-20 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" type="number" value="${part.qty || 1}"/></td>
                    <td class="whitespace-nowrap px-3 py-2 text-sm"><input class="unit-cost-input w-24 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" step="0.01" type="number" value="${Number(part.unitCost || 0).toFixed(2)}"/></td>
                    <td class="row-total whitespace-nowrap px-3 py-2 text-sm text-right font-medium text-[var(--text-primary)]">$0.00</td>
                    <td class="whitespace-nowrap py-2 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                        <button type="button" class="text-red-600 hover:text-red-900 delete-part-btn"><span class="material-icons-outlined text-base">delete</span></button>
                    </td>
                `;
            });
        }

        // Populate subcontractors
        const subList = document.getElementById('subcontractors-list');
        subList.innerHTML = '';
        if (subcontractors && subcontractors.length > 0) {
            subcontractors.forEach(sub => addSubcontractor(sub));
        }

        // Re-add listeners to new inputs
        document.querySelectorAll('#parts-table .qty-input, #parts-table .unit-cost-input').forEach(input => input.addEventListener('input', updateTotals));

        updateTotals(); // Recalculate everything with new rates

        // Populate On Hand Inventory
        const onHandInventoryTitle = Array.from(document.querySelectorAll('h3')).find(h3 => h3.textContent === 'On Hand Inventory');
        if (onHandInventoryTitle) {
            const onHandInventoryList = onHandInventoryTitle.nextElementSibling;
            onHandInventoryList.innerHTML = '';
            if (parts && parts.length > 0) {
                parts.forEach(part => {
                    const onHand = part.onHand || 'N/A';
                    const onHandClass = isNaN(parseInt(onHand)) || parseInt(onHand) > 0 ? 'text-green-600' : 'text-red-600';
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center pt-2';
                    listItem.innerHTML = `
                        <p class="text-sm font-medium text-[var(--text-primary)]">${part.part}</p>
                        <p class="text-sm font-medium ${onHandClass}">${onHand}</p>
                    `;
                    onHandInventoryList.appendChild(listItem);
                });
            }
        }
    }

    async function handleServiceCallImport() {
        const inputEl = document.getElementById('service-call-id');
        const serviceCallId = inputEl.value.trim();

        if (!serviceCallId) {
            alert("Please enter a Service Call ID.");
            clearSheet();
            return;
        }
        inputEl.disabled = true;
        document.getElementById('import-btn').classList.add('animate-pulse');
        try {
            const data = await fetchServiceCallData(serviceCallId);
            if (data && data.revisions && data.revisions.length > 0) {
                quoteState = { serviceCallId, revisions: data.revisions, revision: null, baseData: data.baseData };
                
                // Update page title and header with Service Call ID
                document.getElementById('page-title').textContent = `Quote Sheet - ${serviceCallId}`;
                document.getElementById('quote-header-info').textContent = `Service Call ID: ${serviceCallId}`;
                
                const revisionSelector = document.getElementById('revision-selector');
                revisionSelector.innerHTML = '';
                data.revisions.forEach(rev => {
                    const option = document.createElement('option');
                    option.value = rev.revision;
                    option.textContent = `Rev ${rev.revision}`;
                    revisionSelector.appendChild(option);
                });

                // Select the latest revision
                const latestRevision = data.revisions[data.revisions.length - 1];
                revisionSelector.value = latestRevision.revision;
                quoteState.revision = latestRevision.revision;
                populateBaseData(data.baseData);
                populateQuoteWithData(latestRevision);

                // Enable UI
                revisionSelector.disabled = false;
                document.getElementById('update-revision-btn').disabled = false;
                document.getElementById('save-revision-btn').disabled = false;

            } else if (data && data.baseData) {
                // No revisions, but ERP/base data exists.
                // REMOVED: alert(`Service Call ID "${serviceCallId}" found. You can create the first revision.`);
                quoteState = { serviceCallId, revisions: [], revision: 1, baseData: data.baseData };
                populateBaseData(data.baseData);
                
                // Clear any existing transactional data
                document.querySelector('#parts-table tbody').innerHTML = '';
                document.getElementById('subcontractors-list').innerHTML = '';
                document.getElementById('tech-count').value = '0';
                document.getElementById('tech-hours').value = '0';
                document.getElementById('travel-hours').value = '0';
                updateTotals();

                const revisionSelector = document.getElementById('revision-selector');
                revisionSelector.innerHTML = '<option value="1">Rev 1</option>';
                revisionSelector.disabled = true;
                document.getElementById('update-revision-btn').disabled = true; // Can't update a non-existent revision
                document.getElementById('save-revision-btn').disabled = false;
            } else {
                alert(`Service Call ID "${serviceCallId}" not found. You can create a new quote, but customer and unit info must be entered manually.`);
                // Do not clear the whole sheet. Instead, prepare it for a new quote with the entered ID.
                resetImportedFields(); // Clears customer/unit info and resets buttons.
                quoteState = { serviceCallId: serviceCallId, revisions: [], revision: 1, baseData: null };

                const revisionSelector = document.getElementById('revision-selector');
                revisionSelector.innerHTML = '<option value="1">Rev 1</option>';
                revisionSelector.disabled = true;
                document.getElementById('update-revision-btn').disabled = true; // Can't update a non-existent revision
                document.getElementById('save-revision-btn').disabled = false; // Allow saving as a new revision.
            }
        } catch (error) {
            console.error("Failed to fetch service call data:", error);
            alert("An error occurred while importing data.");
            clearSheet();
        } finally {
            document.getElementById('import-btn').classList.remove('animate-pulse');
            inputEl.disabled = false;
        }
    }

    async function saveQuote(isNewRevision) {
        if (!quoteState.serviceCallId) {
            alert("Please enter a Service Call ID first.");
            return;
        }
        const revisionToSave = isNewRevision ? (Math.max(0, ...quoteState.revisions.map(r => r.revision)) + 1) : quoteState.revision;

        // Gather all data
        const dataToSave = {
            serviceCallId: quoteState.serviceCallId,
            revision: revisionToSave,
            description: document.getElementById('quote-description-textarea').value,
            customer: {
                name: document.getElementById('customer-name').textContent,
                company: document.getElementById('customer-company').textContent
            },
            labor: {
                techCount: document.getElementById('tech-count').value,
                techHours: document.getElementById('tech-hours').value,
                techRate: document.getElementById('tech-labor-section').dataset.rate,
                travelHours: document.getElementById('travel-hours').value,
                travelRate: document.getElementById('travel-labor-section').dataset.rate
            },
            parts: getPartsDataForSave(),
            subcontractors: Array.from(document.querySelectorAll('#subcontractors-list > div')).map(div => {
                return {
                    contact_name: div.querySelector('input[id^="subcontractor-contact-"]')?.value,
                    contact_details: div.querySelector('input[id^="subcontractor-details-"]')?.value,
                    cost: div.querySelector('input[id^="subcontractor-cost-"]')?.value
                }
            })
        };
        
        console.log("Saving data:", JSON.stringify(dataToSave, null, 2));
        
        try {
            const response = await fetch('/api/quote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSave),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Server responded with status ${response.status}`);
            }

            const result = await response.json();
            alert(result.message);
            
            // Refresh the data on the page to reflect the save
            await handleServiceCallImport();
        } catch (error) {
            console.error("Failed to save quote:", error);
            alert(`Error saving quote: ${error.message}`);
        }
    }


    // --- INITIALIZATION & EVENT LISTENERS ---

    // Setup UI components
    setupMenuButton('menu-button');
    setupTabs('tab-common-parts', 'tab-service-articles', 'panel-common-parts', 'panel-service-articles');

    // Export buttons
    document.getElementById('preview-export-btn')?.addEventListener('click', (e) => { e.preventDefault(); openExportPreview(); });

    // Main action buttons
    document.getElementById('update-revision-btn')?.addEventListener('click', () => saveQuote(false));
    document.getElementById('save-revision-btn')?.addEventListener('click', () => saveQuote(true));
    
    document.getElementById('finalize-send-btn')?.addEventListener('click', () => {
        if (confirm('Are you sure you want to finalize and send this quote?')) {
            alert('Quote has been sent!');
        }
    });

    // Template buttons
    document.getElementById('save-template-btn')?.addEventListener('click', () => {
        const templateData = getPartsDataForSave();
        console.log("Saving template:", JSON.stringify(templateData, null, 2));
        alert('Template data (from the parts table) has been logged to the console.');
    });
    document.getElementById('load-template-btn')?.addEventListener('click', () => alert('Loading from a template would be implemented here, likely by fetching data and populating the parts table.'));

    // Add buttons
    document.getElementById('add-subcontractor-btn')?.addEventListener('click', addSubcontractor);
    document.getElementById('add-part-btn')?.addEventListener('click', addPartRow);

    document.querySelectorAll('.add-to-quote-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const partContainer = btn.closest('li');
            const partNumber = partContainer.querySelector('p.font-medium').textContent;
            const description = partContainer.querySelector('p.text-sm:not(.font-medium)').textContent;

            const tableBody = document.querySelector('#parts-table tbody');
            if (!tableBody) return;

            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td class="whitespace-nowrap py-2 pl-4 pr-3 text-sm font-medium text-[var(--text-primary)] sm:pl-0">${partNumber}</td>
                <td class="whitespace-nowrap px-3 py-2 text-sm"><input class="desc-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm" type="text" value="${description}" placeholder="Description"></td>
                <td class="whitespace-nowrap px-3 py-2 text-sm"><input class="vendor-input w-full rounded-md border-gray-300 shadow-sm sm:text-sm" type="text" value="" placeholder="Vendor"></td>
                <td class="whitespace-nowrap px-3 py-2 text-sm text-red-600 font-medium">N/A</td>
                <td class="whitespace-nowrap px-3 py-2 text-sm"><input class="qty-input w-20 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" type="number" value="1"/></td>
                <td class="whitespace-nowrap px-3 py-2 text-sm"><input class="unit-cost-input w-24 rounded-md border-gray-300 text-right shadow-sm sm:text-sm" step="0.01" type="number" value="0.00"/></td>
                <td class="row-total whitespace-nowrap px-3 py-2 text-sm text-right font-medium text-[var(--text-primary)]">$0.00</td>
                <td class="whitespace-nowrap py-2 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                    <button type="button" class="text-red-600 hover:text-red-900 delete-part-btn"><span class="material-icons-outlined text-base">delete</span></button>
                </td>
            `;
            
            newRow.querySelectorAll('.qty-input, .unit-cost-input').forEach(input => {
                input.addEventListener('input', updateTotals);
            });

            updateTotals();
            newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
    });

    // Listener for deleting part rows (using event delegation)
    const partsTable = document.getElementById('parts-table');
    partsTable?.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-part-btn');
        if (!deleteBtn) return;
        deleteBtn.closest('tr').remove();
        updateTotals();
    });

    // Clear sheet button
    document.getElementById('clear-sheet-btn')?.addEventListener('click', clearSheet);

    // Service Call ID import listener
    document.getElementById('import-btn')?.addEventListener('click', handleServiceCallImport);
    document.getElementById('revision-selector')?.addEventListener('change', (e) => {
        const selectedRevision = parseInt(e.target.value);
        const revisionData = quoteState.revisions.find(r => r.revision === selectedRevision);
        quoteState.revision = selectedRevision;
        populateQuoteWithData(revisionData);
    });

    // Add listeners to all cost/qty inputs on page load
    document.querySelectorAll('.labor-input, #parts-table .qty-input, #parts-table .unit-cost-input, #subcontractors-list input[id^="subcontractor-cost-"]').forEach(input => {
        input.addEventListener('input', updateTotals);
    });

    // --- AI SUMMARY GENERATION ---
    const generateSummaryBtn = document.getElementById('generate-summary-btn');
    if (generateSummaryBtn) {
        generateSummaryBtn.addEventListener('click', async () => {
            const writeUpEl = document.getElementById('service-call-writeup');
            const quoteDescEl = document.getElementById('quote-description-textarea');
            const writeUpText = writeUpEl.value;

            if (!writeUpText.trim()) {
                alert('Please import a service call with a write-up first.');
                return;
            }

            generateSummaryBtn.disabled = true;
            generateSummaryBtn.innerHTML = `<span class="material-icons-outlined text-base mr-2 animate-spin">sync</span>Generating...`;

            try {
                const response = await fetch('/summarize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ writeup: writeUpText }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `API Error: ${response.statusText}`);
                }

                const data = await response.json();
                const suggestedDescription = data.customer_description;
                const techCount = data.tech_count;
                const techHours = data.tech_hours;

                const useSuggestion = confirm(`Suggested Description:\n\n${suggestedDescription}\n\nDo you want to use this?`);
                if (useSuggestion) {
                    quoteDescEl.value = suggestedDescription || '';
                    if (typeof techCount !== 'undefined') document.getElementById('tech-count').value = techCount;
                    if (typeof techHours !== 'undefined') document.getElementById('tech-hours').value = techHours;
                    updateTotals();
                }
            } catch (error) {
                console.error('Error generating summary:', error);
                alert(`Failed to generate description: ${error.message}`);
            } finally {
                generateSummaryBtn.disabled = false;
                generateSummaryBtn.innerHTML = `<span class="material-icons-outlined text-base mr-2">auto_awesome</span>Generate with AI`;
            }
        });
    }

    // Initial calculation on page load
    updateTotals();
});
</script>

<grammarly-desktop-integration data-grammarly-shadow-root="true"></grammarly-desktop-integration></body></html>
